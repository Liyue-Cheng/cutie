# æ—¶åŒºä¸æ—¥æœŸæ¶æ„é—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜æ‘˜è¦

**ç—‡çŠ¶**ï¼šå°†ä»»åŠ¡æ‹–åŠ¨åˆ°æ—¥å†æ—¶ï¼Œä»»åŠ¡éšæœºå‡ºç°åœ¨é”™è¯¯çš„æ—¥æœŸçœ‹æ¿ä¸Šï¼ˆä»Šå¤©ã€æ˜¨å¤©ï¼Œæˆ–æ ¹æœ¬ä¸å‡ºç°ï¼‰

**æ ¹å› **ï¼šæ•°æ®æ¨¡å‹ä¸­"æ—¥å†æ—¥æœŸ"æ¦‚å¿µä¸"UTCæ—¶é—´æˆ³"æ¦‚å¿µæ··æ·†ï¼Œå¯¼è‡´è·¨æ—¶åŒºçš„è¯­ä¹‰ä¸ä¸€è‡´

**ä¸¥é‡æ€§**ï¼šğŸ”´ **æ¶æ„çº§ç¼ºé™·**ï¼ˆä¸æ˜¯å¶ç„¶bugï¼Œä¼šå½±å“æ‰€æœ‰æ—¶åŒºç”¨æˆ·ï¼‰

---

## ä¸€ã€é—®é¢˜æº¯æº

### 1.1 æ•°æ®æµè¿½è¸ª

```
ç”¨æˆ·æ“ä½œï¼ˆæœ¬åœ°æ—¶åŒº UTC+8ï¼‰ï¼š
æ‹–åŠ¨ä»»åŠ¡åˆ° 2025-10-03 02:00
          â†“
å‰ç«¯è½¬æ¢ï¼ˆtoISOStringï¼‰ï¼š
"2025-10-02T18:00:00.000Z"  // UTC æ—¶é—´
          â†“
åç«¯æ¥æ”¶ï¼ˆDateTime<Utc>ï¼‰ï¼š
start_time = 2025-10-02 18:00:00 UTC
          â†“
æ—¥æœŸæå–ï¼ˆ.date_naive()ï¼‰ï¼š
scheduled_day = 2025-10-02 00:00:00 UTC  âŒ é”™è¯¯ï¼
          â†“
å‰ç«¯ç­›é€‰ï¼ˆgetTasksByDateï¼‰ï¼š
task.schedules[0].scheduled_day === "2025-10-02"
kanban.id === "2025-10-03"
          â†“
ç»“æœï¼šä¸åŒ¹é…ï¼Œä»»åŠ¡æ¶ˆå¤±ï¼
```

### 1.2 æ ¸å¿ƒçŸ›ç›¾

| å±‚çº§       | ç±»å‹                  | è¯­ä¹‰           | é—®é¢˜                                      |
| ---------- | --------------------- | -------------- | ----------------------------------------- |
| **æ•°æ®åº“** | `TEXT` (RFC 3339)     | "æŸä¸€å¤©çš„å¼€å§‹" | å­˜å‚¨ä¸ºå®Œæ•´æ—¶é—´æˆ³ï¼Œæ³¨é‡Šè¯´æ˜¯ "start of day" |
| **å®ä½“å±‚** | `DateTime<Utc>`       | UTC æ—¶é—´æˆ³     | ä» UTC æ—¶é—´æå–æ—¥æœŸï¼Œå¿½ç•¥ç”¨æˆ·æ—¶åŒº         |
| **DTOå±‚**  | `String` (YYYY-MM-DD) | æ—¥å†æ—¥æœŸ       | æ ¼å¼åŒ–ä¸ºæ—¥æœŸå­—ç¬¦ä¸²ï¼Œä½†å·²ç»é”™ä½            |
| **å‰ç«¯**   | `string` (YYYY-MM-DD) | ç”¨æˆ·æœ¬åœ°æ—¥æœŸ   | ç”¨æˆ·æ„ŸçŸ¥çš„æ—¥æœŸ                            |

**é—®é¢˜æœ¬è´¨**ï¼š`scheduled_day` åœ¨è¯­ä¹‰ä¸Šè¡¨è¾¾"æ—¥å†æ—¥æœŸ"ï¼Œä½†åœ¨æŠ€æœ¯ä¸Šä½¿ç”¨"UTCæ—¶é—´æˆ³"å­˜å‚¨å’Œè®¡ç®—ã€‚

---

##äºŒã€æ¶æ„ç¼ºé™·åˆ†æ

### 2.1 è¿™æ˜¯æ¶æ„é—®é¢˜ï¼Œä¸æ˜¯å¶ç„¶bug

âœ… **è¯æ®1ï¼šç³»ç»Ÿæ€§å½±å“**

- å½±å“æ‰€æœ‰æ—¶åŒºä¸º UTC+Nï¼ˆN>0ï¼‰çš„ç”¨æˆ·
- å½±å“æ‰€æœ‰æ¶‰åŠ"æ—¥æœŸ"æ¦‚å¿µçš„åŠŸèƒ½ï¼ˆæ—¥ç¨‹ã€æ—¶é—´å—ã€æ—¥è§†å›¾ï¼‰
- éç‰¹å®šåœºæ™¯çš„å¶ç„¶é”™è¯¯

âœ… **è¯æ®2ï¼šæ•°æ®æ¨¡å‹ä¸åŒ¹é…**

```rust
// å®ä½“å±‚ï¼šä½¿ç”¨ DateTime<Utc> è¡¨è¾¾"æ—¥æœŸ"æ¦‚å¿µ
pub scheduled_day: DateTime<Utc>, // âŒ ç±»å‹ä¸åŒ¹é…è¯­ä¹‰

// åº”è¯¥ä½¿ç”¨ï¼š
pub scheduled_day: NaiveDate,      // âœ… çº¯æ—¥æœŸï¼Œæ— æ—¶åŒº
// æˆ–
pub scheduled_day: String,          // âœ… "YYYY-MM-DD"
```

âœ… **è¯æ®3ï¼šä¸šåŠ¡è¯­ä¹‰æ··ä¹±**

- ç”¨æˆ·å…³å¿ƒï¼š"æˆ‘æŠŠä»»åŠ¡å®‰æ’åˆ°å“ªä¸€å¤©"ï¼ˆæ—¥å†æ—¥æœŸï¼‰
- ç³»ç»Ÿå®ç°ï¼š"ä»»åŠ¡çš„ scheduled_day æ˜¯ä»€ä¹ˆæ—¶åˆ»"ï¼ˆæ—¶é—´æˆ³ï¼‰
- **ä¸šåŠ¡è¯­ä¹‰ä¸æŠ€æœ¯å®ç°ä¸ä¸€è‡´**

### 2.2 ä¸ºä»€ä¹ˆä½¿ç”¨ DateTime<Utc> æ˜¯é”™è¯¯çš„ï¼Ÿ

**åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯             | æ­£ç¡®ç±»å‹                | åŸå›                        |
| ---------------- | ----------------------- | -------------------------- |
| ä»»åŠ¡æˆªæ­¢æ—¶é—´     | `DateTime<Utc>`         | éœ€è¦ç²¾ç¡®æ—¶åˆ»ï¼Œè·¨æ—¶åŒºåä½œ   |
| ä¼šè®®å¼€å§‹æ—¶é—´     | `DateTime<Utc>`         | éœ€è¦ç²¾ç¡®æ—¶åˆ»ï¼Œæ—¶åŒºè½¬æ¢     |
| **ä»»åŠ¡å®‰æ’æ—¥æœŸ** | `NaiveDate` æˆ– `String` | **åªå…³å¿ƒæ—¥æœŸï¼Œä¸å…³å¿ƒæ—¶åˆ»** |
| ç”Ÿæ—¥ã€çºªå¿µæ—¥     | `NaiveDate`             | çº¯æ—¥å†æ—¥æœŸï¼Œä¸æ—¶åŒºæ— å…³     |

**å½“å‰è®¾è®¡çš„é—®é¢˜**ï¼š

```rust
// âŒ é”™è¯¯ï¼šç”¨æ—¶é—´æˆ³è¡¨è¾¾æ—¥æœŸ
let scheduled_day = start_time.date_naive().and_hms_opt(0, 0, 0).unwrap().and_utc();
// é—®é¢˜ï¼šUTC 2025-10-02 00:00 å¯¹äº UTC+8 ç”¨æˆ·æ˜¯ 2025-10-02 08:00 æœ¬åœ°æ—¶é—´
//       ç”¨æˆ·æ‹–åŠ¨çš„æ˜¯ 2025-10-03 02:00 æœ¬åœ°æ—¶é—´ï¼Œè½¬æ¢åå˜æˆ 2025-10-02
```

---

## ä¸‰ã€æ˜¯å¦éœ€è¦æ—¶åŒºå­—æ®µï¼Ÿ

### 3.1 ç»“è®ºï¼šâŒ **ä¸éœ€è¦**

**åŸå› **ï¼š

1. **Cutie æ˜¯å•ç”¨æˆ·åº”ç”¨**ï¼Œç”¨æˆ·ä¸ä¼šåˆ‡æ¢æ—¶åŒºä½¿ç”¨
2. **é—®é¢˜ä¸åœ¨æ—¶åŒºï¼Œåœ¨æ—¥æœŸç±»å‹é€‰æ‹©**
3. å³ä½¿è®°å½•æ—¶åŒºï¼Œä¹Ÿæ— æ³•è§£å†³"æ—¥å†æ—¥æœŸ"ä¸"æ—¶é—´æˆ³"çš„è¯­ä¹‰æ··æ·†

### 3.2 å¤šç”¨æˆ·åº”ç”¨æ‰éœ€è¦æ—¶åŒºå­—æ®µ

```rust
// âŒ å½“å‰å•ç”¨æˆ·åº”ç”¨ä¸éœ€è¦
pub struct TaskSchedule {
    pub scheduled_day: DateTime<Utc>,
    pub user_timezone: String,  // ä¸éœ€è¦ï¼
}

// âœ… æ­£ç¡®åšæ³•ï¼šç›´æ¥å­˜å‚¨æ—¥æœŸ
pub struct TaskSchedule {
    pub scheduled_day: NaiveDate,  // æˆ– String "YYYY-MM-DD"
}
```

---

## å››ã€è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆAï¼šè¯·æ±‚å¢åŠ  `scheduled_date` å­—æ®µï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

```rust
pub struct CreateFromTaskRequest {
    pub start_time: DateTime<Utc>,
    pub scheduled_date: String,  // "2025-10-03"
}
```

**ä¼˜ç‚¹**ï¼š

- âœ… å¿«é€Ÿä¿®å¤ï¼Œæ— éœ€æ•°æ®åº“è¿ç§»
- âœ… API è¯­ä¹‰æ¸…æ™°
- âœ… å‘å‰å…¼å®¹

**ç¼ºç‚¹**ï¼š

- âš ï¸ æ•°æ®å†—ä½™ï¼ˆstart_time å’Œ scheduled_date éƒ½è¡¨è¾¾æ—¥æœŸï¼‰
- âš ï¸ æœªè§£å†³æ ¹æœ¬é—®é¢˜ï¼ˆscheduled_day ä»æ˜¯ DateTimeï¼‰

**æ¨èæŒ‡æ•°**ï¼šâ­â­â­â­ ä½œä¸ºçŸ­æœŸä¿®å¤

---

### æ–¹æ¡ˆBï¼šå‰ç«¯ä¼ é€’"æ—¥æœŸè¾¹ç•Œæ—¶é—´æˆ³"ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

```typescript
// å‰ç«¯ç¡®ä¿ start_time å§‹ç»ˆæ˜¯è¯¥æ—¥æœŸçš„ UTC é›¶ç‚¹
const startTime = new Date('2025-10-03T00:00:00.000Z')
```

**ä¼˜ç‚¹**ï¼š

- âœ… æ— éœ€æ”¹åç«¯

**ç¼ºç‚¹**ï¼š

- âŒ å‰ç«¯é€»è¾‘å¤æ‚ä¸”æ˜“é”™
- âŒ è¿åä¸šåŠ¡è¯­ä¹‰ï¼ˆæ—¶é—´å—çš„å¼€å§‹æ—¶é—´ä¸åº”è¯¥è¢«å¼ºåˆ¶æ”¹ä¸ºé›¶ç‚¹ï¼‰
- âŒ æ—¶åŒºé—®é¢˜ä»ç„¶å­˜åœ¨

**æ¨èæŒ‡æ•°**ï¼šâ­ ä¸æ¨è

---

### æ–¹æ¡ˆCï¼šæ•°æ®æ¨¡å‹é‡æ„ï¼ˆæ ¹æ²»æ–¹æ¡ˆï¼‰

```sql
-- æ•°æ®åº“è¿ç§»
ALTER TABLE task_schedules
MODIFY scheduled_day TEXT; -- å­˜å‚¨ "YYYY-MM-DD"ï¼Œä¸æ˜¯æ—¶é—´æˆ³
```

```rust
// å®ä½“å±‚
pub struct TaskSchedule {
    pub scheduled_day: chrono::NaiveDate,  // çº¯æ—¥æœŸ
}

// æˆ–ä½¿ç”¨å­—ç¬¦ä¸²
pub struct TaskSchedule {
    pub scheduled_day: String,  // "YYYY-MM-DD"
}
```

**ä¼˜ç‚¹**ï¼š

- âœ… ä»æ ¹æœ¬ä¸Šè§£å†³ç±»å‹ä¸åŒ¹é…
- âœ… ä¸šåŠ¡è¯­ä¹‰æ¸…æ™°
- âœ… é¿å…æ‰€æœ‰æ—¶åŒºç›¸å…³bug

**ç¼ºç‚¹**ï¼š

- âš ï¸ éœ€è¦æ•°æ®åº“è¿ç§»
- âš ï¸ å½±å“æ‰€æœ‰ç›¸å…³ä»£ç ï¼ˆAssemblerã€Repositoryï¼‰
- âš ï¸ éœ€è¦å›å½’æµ‹è¯•

**æ¨èæŒ‡æ•°**ï¼šâ­â­â­â­â­ é•¿æœŸæœ€ä½³æ–¹æ¡ˆ

---

### æ–¹æ¡ˆDï¼šæ™ºèƒ½æ—¥æœŸæå–ï¼ˆå¦¥åæ–¹æ¡ˆï¼‰

```rust
// ä½¿ç”¨ start_time çš„"æœ¬åœ°æ—¥æœŸ"
use chrono::FixedOffset;

let user_offset = FixedOffset::east_opt(8 * 3600).unwrap(); // UTC+8
let local_time = request.start_time.with_timezone(&user_offset);
let scheduled_day = local_time.date_naive().and_hms_opt(0, 0, 0).unwrap().and_utc();
```

**ä¼˜ç‚¹**ï¼š

- âœ… æ— éœ€æ•°æ®åº“è¿ç§»
- âœ… è§£å†³å½“å‰é—®é¢˜

**ç¼ºç‚¹**ï¼š

- âŒ éœ€è¦é…ç½®ç”¨æˆ·æ—¶åŒº
- âŒ ä»æœªè§£å†³ç±»å‹ä¸åŒ¹é…çš„æ ¹æœ¬é—®é¢˜
- âš ï¸ å¢åŠ å¤æ‚åº¦

**æ¨èæŒ‡æ•°**ï¼šâ­â­â­ å¦‚æœä¸æƒ³å¤§æ”¹å¯ä»¥è€ƒè™‘

---

## äº”ã€æ¨èçš„è¡ŒåŠ¨æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šç«‹å³ä¿®å¤ï¼ˆä»Šå¤©ï¼‰

é‡‡ç”¨ **æ–¹æ¡ˆA** + éƒ¨åˆ† **æ–¹æ¡ˆD**

1. **åç«¯**ï¼šå¢åŠ  `scheduled_date` å¯é€‰å­—æ®µï¼Œä¼˜å…ˆä½¿ç”¨ï¼Œå›é€€åˆ°æ™ºèƒ½æå–

```rust
let scheduled_day = if let Some(date_str) = request.scheduled_date {
    // ç›´æ¥ä½¿ç”¨å‰ç«¯ä¼ é€’çš„æ—¥æœŸ
    chrono::NaiveDate::parse_from_str(&date_str, "%Y-%m-%d")?
        .and_hms_opt(0, 0, 0).unwrap().and_utc()
} else {
    // å›é€€ï¼šæ™ºèƒ½æå–ï¼ˆå‡è®¾ UTC+8ï¼Œåç»­å¯é…ç½®ï¼‰
    let offset = FixedOffset::east_opt(8 * 3600).unwrap();
    request.start_time.with_timezone(&offset)
        .date_naive().and_hms_opt(0, 0, 0).unwrap().and_utc()
};
```

2. **å‰ç«¯**ï¼šä¼ é€’ `scheduled_date`

```typescript
await timeBlockStore.createTimeBlockFromTask({
  task_id: task.id,
  start_time: dropTime.toISOString(),
  end_time: endTime.toISOString(),
  scheduled_date: formatDate(dropTime), // "YYYY-MM-DD"
})
```

### é˜¶æ®µ2ï¼šæ¶æ„é‡æ„ï¼ˆä¸‹ä¸€ä¸ªè¿­ä»£ï¼‰

é‡‡ç”¨ **æ–¹æ¡ˆC**

1. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
2. ä¿®æ”¹å®ä½“å±‚ï¼š`scheduled_day: NaiveDate`
3. æ›´æ–°æ‰€æœ‰ Repository å’Œ Assembler
4. å…¨é¢å›å½’æµ‹è¯•

---

## å…­ã€ç›¸ä¼¼é—®é¢˜æ’æŸ¥

éœ€è¦æ£€æŸ¥çš„å…¶ä»–ç«¯ç‚¹ï¼š

| ç«¯ç‚¹                   | æ˜¯å¦å—å½±å“ | ä¿®å¤ä¼˜å…ˆçº§ |
| ---------------------- | ---------- | ---------- |
| âœ… `create_from_task`  | å·²è¯†åˆ«     | P0ï¼ˆç«‹å³ï¼‰ |
| âš ï¸ `add_schedule`      | å¯èƒ½å—å½±å“ | P0         |
| âš ï¸ `update_schedule`   | å¯èƒ½å—å½±å“ | P1         |
| âš ï¸ `get_daily_tasks`   | å¯èƒ½å—å½±å“ | P0         |
| âš ï¸ `return_to_staging` | å¯èƒ½å—å½±å“ | P1         |

**æ£€æŸ¥æ ‡å‡†**ï¼šæ‰€æœ‰ä» `DateTime<Utc>` æå–æ—¥æœŸç”¨äº `scheduled_day` çš„åœ°æ–¹

---

## ä¸ƒã€æ€»ç»“

### é—®é¢˜æ€§è´¨

- **ä¸æ˜¯å¶ç„¶bug**ï¼Œæ˜¯**æ¶æ„çº§ç¼ºé™·**
- æ ¹å› ï¼šæ•°æ®æ¨¡å‹ä¸­"æ—¥å†æ—¥æœŸ"ä¸"æ—¶é—´æˆ³"æ¦‚å¿µæ··æ·†
- å½±å“èŒƒå›´ï¼šæ‰€æœ‰æ¶‰åŠæ—¥æœŸçš„åŠŸèƒ½

### æ˜¯å¦éœ€è¦æ—¶åŒºå­—æ®µï¼Ÿ

- **ä¸éœ€è¦**ï¼Œå•ç”¨æˆ·åº”ç”¨
- é—®é¢˜åœ¨ç±»å‹é€‰æ‹©ï¼Œä¸åœ¨æ—¶åŒºå­˜å‚¨

### æ¨èæ–¹æ¡ˆ

1. **çŸ­æœŸ**ï¼šå¢åŠ  `scheduled_date` å­—æ®µï¼ˆæ–¹æ¡ˆAï¼‰
2. **é•¿æœŸ**ï¼šé‡æ„ä¸º `NaiveDate`ï¼ˆæ–¹æ¡ˆCï¼‰

### æ¶æ„å¯ç¤º

> **"æ—¥å†æ—¥æœŸ"å’Œ"æ—¶é—´æˆ³"æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œåº”ä½¿ç”¨ä¸åŒçš„ç±»å‹è¡¨è¾¾ã€‚**

- éœ€è¦ç²¾ç¡®æ—¶åˆ» â†’ `DateTime<Utc>`
- åªå…³å¿ƒæ—¥æœŸ â†’ `NaiveDate` æˆ– `String (YYYY-MM-DD)`

---

**æŠ¥å‘Šç¼–å†™æ—¶é—´**ï¼š2025-10-03  
**ä¸¥é‡æ€§è¯„çº§**ï¼šğŸ”´ P0 - æ¶æ„ç¼ºé™·  
**å»ºè®®ä¿®å¤æ—¶é—´**ï¼šç«‹å³ï¼ˆé˜¶æ®µ1ï¼‰+ ä¸‹ä¸€è¿­ä»£ï¼ˆé˜¶æ®µ2ï¼‰
