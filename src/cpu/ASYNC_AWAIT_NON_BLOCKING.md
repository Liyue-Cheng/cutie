# ğŸ§µ Async/Await ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹

## ğŸ¯ æ ¸å¿ƒç»“è®º

**å½“ç»„ä»¶ä½¿ç”¨ `await pipeline.dispatch()` æ—¶ï¼š**

- âœ… **ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹**
- âœ… **ä¸ä¼šé˜»å¡ UI æ¸²æŸ“**
- âœ… **ä¸ä¼šå ç”¨ CPU**
- âœ… **äº‹ä»¶å¾ªç¯ç»§ç»­è¿è¡Œ**

---

## ğŸ” åŸç†è§£é‡Š

### 1. `await` çš„å·¥ä½œæœºåˆ¶

```typescript
// ç»„ä»¶ä»£ç 
async function createTask() {
  console.log('æ­¥éª¤ 1: å¼€å§‹')

  const result = await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' })
  //              ^^^^^ åœ¨è¿™é‡Œ"ç­‰å¾…"

  console.log('æ­¥éª¤ 2: å®Œæˆ', result)
}
```

#### æ‰§è¡Œæµç¨‹

```
æ—¶é—´çº¿                ä¸»çº¿ç¨‹                          ç½‘ç»œ/åå°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0ms    â”‚ createTask() è¢«è°ƒç”¨
         â”‚ console.log('æ­¥éª¤ 1: å¼€å§‹')
         â”‚ pipeline.dispatch() è¢«è°ƒç”¨
         â”‚   â””â”€> åˆ›å»º Promise
         â”‚   â””â”€> å‘å°„æŒ‡ä»¤åˆ°è°ƒåº¦å™¨
         â”‚   â””â”€> è§¦å‘ç½‘ç»œè¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  å‘é€ HTTP è¯·æ±‚
         â”‚ await å…³é”®å­—
         â”‚   â””â”€> æš‚åœ createTask() å‡½æ•°
         â”‚   â””â”€> ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡! âœ…
         â”‚
T+10ms   â”‚ å¤„ç†ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ âœ…
T+20ms   â”‚ æ¸²æŸ“ UI æ›´æ–° âœ…
T+30ms   â”‚ æ‰§è¡Œå®šæ—¶å™¨å›è°ƒ âœ…
         â”‚
T+123ms  â”‚                                         ç½‘ç»œè¯·æ±‚å®Œæˆ
         â”‚ Promise resolve                 <â”€â”€â”€â”€â”€â”€â”€  è¿”å›æ•°æ®
         â”‚ æ¢å¤ createTask() å‡½æ•°
         â”‚ console.log('æ­¥éª¤ 2: å®Œæˆ')
         â”‚ createTask() å®Œæˆ
```

### å…³é”®ç‚¹

1. **`await` ä¸æ˜¯"ç­‰å¾…"ï¼ˆwaitï¼‰**
   - âŒ ä¸æ˜¯åƒåŒæ­¥ä»£ç é‚£æ ·"å¡ä½"
   - âœ… æ˜¯"è®©å‡ºæ‰§è¡Œæƒï¼Œç¨åç»§ç»­"

2. **ä¸»çº¿ç¨‹ç»§ç»­è¿è¡Œ**

   ```typescript
   async function a() {
     await fetch('...') // a() æš‚åœ
   }

   async function b() {
     await fetch('...') // b() æš‚åœ
   }

   a() // å‘èµ·è¯·æ±‚ï¼Œæš‚åœ
   b() // å‘èµ·è¯·æ±‚ï¼Œæš‚åœ

   // ä¸»çº¿ç¨‹ï¼šç»§ç»­å¤„ç†ç‚¹å‡»ã€æ¸²æŸ“ã€å®šæ—¶å™¨ç­‰ âœ…
   ```

3. **ç½‘ç»œè¯·æ±‚ä¸å ç”¨ CPU**
   ```typescript
   await pipeline.dispatch('task.create', { ... })
   //              ^
   //              ç½‘ç»œè¯·æ±‚ç”±æµè§ˆå™¨åº•å±‚ï¼ˆC++ï¼‰å¤„ç†
   //              JavaScript ä¸»çº¿ç¨‹ä¸å‚ä¸
   //              ä¸å ç”¨ CPU âœ…
   ```

---

## ğŸ“Š å¯¹æ¯”ï¼šåŒæ­¥ vs å¼‚æ­¥

### âŒ åŒæ­¥ä»£ç ï¼ˆé˜»å¡ï¼‰

```javascript
// å‡è®¾æœ‰ä¸ªåŒæ­¥çš„ç½‘ç»œè¯·æ±‚ï¼ˆå®é™…ä¸å­˜åœ¨ï¼‰
function createTaskSync() {
  console.log('æ­¥éª¤ 1')

  const result = httpRequestSync('/api/tasks') // âŒ é˜»å¡ï¼
  //             ^^^^^^^^^^^^^^^^
  //             ä¸»çº¿ç¨‹å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…ç½‘ç»œå“åº”
  //             UI å†»ç»“ âŒ
  //             ç‚¹å‡»æ— å“åº” âŒ
  //             åŠ¨ç”»åœæ­¢ âŒ

  console.log('æ­¥éª¤ 2', result)
}
```

### âœ… å¼‚æ­¥ä»£ç ï¼ˆä¸é˜»å¡ï¼‰

```typescript
// ä½¿ç”¨ async/await
async function createTask() {
  console.log('æ­¥éª¤ 1')

  const result = await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' })
  //             ^^^^^
  //             æš‚åœå½“å‰å‡½æ•°
  //             ä¸»çº¿ç¨‹ç»§ç»­è¿è¡Œ âœ…
  //             UI ä¿æŒå“åº” âœ…
  //             ç‚¹å‡»ä»ç„¶å“åº” âœ…
  //             åŠ¨ç”»ç»§ç»­æ’­æ”¾ âœ…

  console.log('æ­¥éª¤ 2', result)
}
```

---

## ğŸ¨ å®é™…éªŒè¯

### æµ‹è¯• 1: UI åœ¨ç­‰å¾…æœŸé—´ä»ç„¶å“åº”

```vue
<template>
  <div>
    <button @click="createSlowTask">åˆ›å»ºä»»åŠ¡ï¼ˆéœ€è¦ 10 ç§’ï¼‰</button>
    <button @click="counter++">è®¡æ•°: {{ counter }}</button>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { pipeline } from '@/cpu'

const counter = ref(0)

async function createSlowTask() {
  console.log('å¼€å§‹åˆ›å»ºä»»åŠ¡...')

  // ğŸ”¥ await 10 ç§’çš„è¯·æ±‚
  await pipeline.dispatch('debug.fetch_with_delay', { delay: 10000 })

  console.log('ä»»åŠ¡åˆ›å»ºå®Œæˆï¼')
}
</script>
```

**æµ‹è¯•æ­¥éª¤**ï¼š

1. ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"æŒ‰é’®
2. åœ¨ç­‰å¾… 10 ç§’æœŸé—´ï¼Œç‚¹å‡»"è®¡æ•°"æŒ‰é’®
3. âœ… è®¡æ•°ä»ç„¶ä¼šå¢åŠ ï¼ï¼ˆUI æ²¡æœ‰å†»ç»“ï¼‰
4. âœ… é¡µé¢æ»šåŠ¨ä»ç„¶æµç•…ï¼
5. âœ… åŠ¨ç”»ç»§ç»­æ’­æ”¾ï¼

### æµ‹è¯• 2: CPU å ç”¨ç‡

```typescript
// æ‰“å¼€æµè§ˆå™¨ä»»åŠ¡ç®¡ç†å™¨ï¼ˆShift + Escï¼‰

async function test() {
  // å‘èµ· 100 ä¸ªå¹¶å‘è¯·æ±‚
  const promises = []
  for (let i = 0; i < 100; i++) {
    promises.push(pipeline.dispatch('debug.fetch_with_delay', { delay: 5000 }))
  }

  // ç­‰å¾…æ‰€æœ‰å®Œæˆ
  await Promise.all(promises)
}

test()

// è§‚å¯Ÿ CPU å ç”¨ç‡ï¼š
// âœ… JavaScript è¿›ç¨‹ CPU: < 5%ï¼ˆåŸºæœ¬æ²¡å˜åŒ–ï¼‰
// âœ… ç½‘ç»œ I/O: æ´»è·ƒï¼ˆä½†ä¸å ç”¨ CPUï¼‰
// âœ… UI ä»ç„¶æµç•…
```

---

## ğŸ§  JavaScript äº‹ä»¶å¾ªç¯

### äº‹ä»¶å¾ªç¯æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           JavaScript ä¸»çº¿ç¨‹                 â”‚
â”‚  (å•çº¿ç¨‹ï¼Œä½†ä¸ä¼šè¢« await é˜»å¡)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            äº‹ä»¶å¾ªç¯ (Event Loop)           â”‚
â”‚                                            â”‚
â”‚  1. æ‰§è¡ŒåŒæ­¥ä»£ç                            â”‚
â”‚  2. æ£€æŸ¥ Promise é˜Ÿåˆ—                      â”‚
â”‚  3. æ£€æŸ¥å®šæ—¶å™¨é˜Ÿåˆ—                         â”‚
â”‚  4. æ£€æŸ¥ I/O äº‹ä»¶                          â”‚
â”‚  5. æ¸²æŸ“ UI                                â”‚
â”‚  6. é‡å¤...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æµè§ˆå™¨åº•å±‚ï¼ˆC++ å®ç°ï¼‰               â”‚
â”‚                                            â”‚
â”‚  - ç½‘ç»œè¯·æ±‚ï¼ˆå¤šçº¿ç¨‹ï¼‰                       â”‚
â”‚  - å®šæ—¶å™¨ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰                       â”‚
â”‚  - UI æ¸²æŸ“ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### await çš„è¡Œä¸º

```typescript
async function example() {
  console.log('A')

  await fetch('/api') // æš‚åœ example() å‡½æ•°
  //    ^^^^^
  //    1. å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆäº¤ç»™æµè§ˆå™¨åº•å±‚ï¼‰
  //    2. æŠŠ"ç»§ç»­æ‰§è¡Œ"å›è°ƒæ”¾å…¥ Promise é˜Ÿåˆ—
  //    3. é€€å‡ºå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡
  //    4. ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ âœ…

  console.log('B') // ç½‘ç»œå®Œæˆåæ‰æ‰§è¡Œ
}

example()
console.log('C')

// è¾“å‡ºé¡ºåºï¼š
// A
// C  â† ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼
// B  â† ç½‘ç»œå®Œæˆåæ‰æ‰§è¡Œ
```

---

## ğŸ’» CPU å ç”¨åˆ†æ

### 1. `await pipeline.dispatch()` çš„ CPU å¼€é”€

```typescript
async function createTask() {
  const result = await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' })
  //                   ^^^^^^^^^^^^^^^^^^^
  //                   è¿™ä¸ªè°ƒç”¨æœ¬èº«çš„ CPU å¼€é”€
}
```

**CPU å¼€é”€åˆ†è§£**ï¼š

| é˜¶æ®µ                 | CPU å ç”¨   | è€—æ—¶     | è¯´æ˜                           |
| -------------------- | ---------- | -------- | ------------------------------ |
| **IF**: åˆ›å»ºæŒ‡ä»¤     | < 0.1ms    | < 1ms    | å¯¹è±¡åˆ›å»º + ID ç”Ÿæˆ             |
| **SCH**: è°ƒåº¦æ£€æµ‹    | < 0.1ms    | < 1ms    | èµ„æºå†²çªæ£€æµ‹                   |
| **EX**: ä¹è§‚æ›´æ–°     | 0.1-1ms    | 1-5ms    | æ·±æ‹·è´ + store æ›´æ–°            |
| **EX**: å‘é€ç½‘ç»œè¯·æ±‚ | < 0.1ms    | < 1ms    | è°ƒç”¨ fetch API                 |
| **ç­‰å¾…ç½‘ç»œå“åº”**     | **0ms** âœ… | 50-500ms | **æµè§ˆå™¨åº•å±‚å¤„ç†ï¼Œä¸å ç”¨ CPU** |
| **WB**: commit       | 0.1-1ms    | 1-5ms    | store æ›´æ–°                     |

**æ€» CPU æ—¶é—´**ï¼š< 10ms  
**æ€»è€—æ—¶**ï¼š50-500msï¼ˆå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…ç½‘ç»œï¼‰  
**CPU å ç”¨ç‡**ï¼š< 2%

### 2. å¹¶å‘åœºæ™¯

```typescript
// åŒæ—¶å‘èµ· 100 ä¸ªè¯·æ±‚
const promises = []
for (let i = 0; i < 100; i++) {
  promises.push(pipeline.dispatch('task.create', { title: `ä»»åŠ¡${i}` }))
}
await Promise.all(promises)
```

**CPU å ç”¨åˆ†æ**ï¼š

| é˜¶æ®µ                | CPU å ç”¨   |
| ------------------- | ---------- |
| åˆ›å»º 100 ä¸ªæŒ‡ä»¤     | < 10ms     |
| è°ƒåº¦ 100 ä¸ªæŒ‡ä»¤     | < 10ms     |
| åº”ç”¨ 100 ä¸ªä¹è§‚æ›´æ–° | < 100ms    |
| å‘é€ 100 ä¸ªç½‘ç»œè¯·æ±‚ | < 10ms     |
| **ç­‰å¾… 100 ä¸ªå“åº”** | **0ms** âœ… |
| å¤„ç† 100 ä¸ª commit  | < 100ms    |

**æ€» CPU æ—¶é—´**ï¼š< 250ms  
**æ€»è€—æ—¶**ï¼š1-5 ç§’ï¼ˆå–å†³äºç½‘ç»œï¼‰  
**CPU å ç”¨ç‡**ï¼š< 5%

---

## ğŸ¨ ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”

### Pythonï¼ˆå¤šçº¿ç¨‹ï¼Œä½† GILï¼‰

```python
# Python çš„ awaitï¼ˆasyncioï¼‰
async def create_task():
    result = await http_client.post('/api/tasks', ...)
    #        ^^^^^
    #        é‡Šæ”¾ GILï¼Œè®©å…¶ä»–åç¨‹è¿è¡Œ
    #        ä½†ä»åœ¨åŒä¸€çº¿ç¨‹
    return result

# âš ï¸ CPU å¯†é›†å‹æ“ä½œä¼šé˜»å¡
async def heavy_computation():
    data = heavy_cpu_work()  # âŒ é˜»å¡äº‹ä»¶å¾ªç¯
    await asyncio.sleep(0)   # éœ€è¦æ˜¾å¼è®©å‡º
```

### Rustï¼ˆçœŸæ­£çš„å¤šçº¿ç¨‹ï¼‰

```rust
// Rust çš„ awaitï¼ˆtokioï¼‰
async fn create_task() -> Result<Task> {
    let result = client.post("/api/tasks").await?;
    //                                     ^^^^^
    //                       å¯èƒ½åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œ
    //                       çœŸæ­£çš„å¹¶å‘
    Ok(result)
}

// âœ… CPU å¯†é›†å‹æ“ä½œä¸ä¼šé˜»å¡
tokio::spawn(async {
    heavy_cpu_work();  // åœ¨ç‹¬ç«‹çº¿ç¨‹è¿è¡Œ
});
```

### JavaScriptï¼ˆå•çº¿ç¨‹ï¼Œä½†å¼‚æ­¥ I/Oï¼‰

```typescript
// JavaScript çš„ await
async function createTask() {
  const result = await pipeline.dispatch('task.create', { ... })
  //             ^^^^^
  //             æš‚åœå‡½æ•°ï¼Œè®©å‡ºä¸»çº¿ç¨‹
  //             ç½‘ç»œè¯·æ±‚ç”±æµè§ˆå™¨åº•å±‚ï¼ˆC++ï¼‰å¤„ç†
  //             ä¸å ç”¨ JavaScript CPU âœ…
  return result
}

// âœ… I/O æ“ä½œä¸é˜»å¡
// âš ï¸ ä½† CPU å¯†é›†å‹æ“ä½œä¼šé˜»å¡
function heavyWork() {
  for (let i = 0; i < 1000000000; i++) {
    // âŒ è¿™ä¼šé˜»å¡ä¸»çº¿ç¨‹
  }
}
```

---

## ğŸ“Š å®é™…æµ‹è¯•

### æµ‹è¯• 1: ä¸»çº¿ç¨‹æ˜¯å¦é˜»å¡

```typescript
async function test() {
  console.time('Total')
  console.time('CPU Time')

  // å‘èµ·ç½‘ç»œè¯·æ±‚
  await pipeline.dispatch('debug.fetch_with_delay', { delay: 5000 })

  console.timeEnd('CPU Time') // è¾“å‡ºï¼šCPU Time: ~10ms âœ…
  console.timeEnd('Total') // è¾“å‡ºï¼šTotal: ~5010ms
}

// ç»“è®ºï¼š
// - æ€»è€—æ—¶ 5010msï¼ˆç­‰å¾…ç½‘ç»œï¼‰
// - CPU æ—¶é—´ 10msï¼ˆå®é™…è®¡ç®—ï¼‰
// - CPU å ç”¨ç‡ï¼š10/5010 = 0.2% âœ…
```

### æµ‹è¯• 2: UI æ˜¯å¦å“åº”

```html
<template>
  <div>
    <button @click="slowOperation">æ…¢æ“ä½œï¼ˆ5ç§’ï¼‰</button>
    <button @click="counter++">å¿«é€Ÿç‚¹å‡»æµ‹è¯•</button>
    <div>è®¡æ•°: {{ counter }}</div>
    <div class="animation">æ—‹è½¬åŠ¨ç”»</div>
  </div>
</template>

<script setup lang="ts">
  const counter = ref(0)

  async function slowOperation() {
    console.log('å¼€å§‹æ…¢æ“ä½œ')

    // await 5 ç§’çš„ç½‘ç»œè¯·æ±‚
    await pipeline.dispatch('debug.fetch_with_delay', { delay: 5000 })

    console.log('æ…¢æ“ä½œå®Œæˆ')
  }
</script>

<style scoped>
  .animation {
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>
```

**æµ‹è¯•ç»“æœ**ï¼š

1. âœ… ç‚¹å‡»"æ…¢æ“ä½œ"åï¼ŒåŠ¨ç”»ç»§ç»­æ—‹è½¬
2. âœ… ç‚¹å‡»"å¿«é€Ÿç‚¹å‡»æµ‹è¯•"ï¼Œè®¡æ•°ç«‹å³å¢åŠ 
3. âœ… é¡µé¢æ»šåŠ¨æµç•…
4. âœ… æ§åˆ¶å°æ—¥å¿—å®æ—¶æ‰“å°

**ç»“è®º**ï¼š**UI å®Œå…¨æ²¡æœ‰å†»ç»“ï¼** âœ…

### æµ‹è¯• 3: å¹¶å‘æ€§èƒ½

```typescript
// åŒæ—¶å‘èµ· 1000 ä¸ªè¯·æ±‚
async function stressTest() {
  const start = performance.now()

  const promises = []
  for (let i = 0; i < 1000; i++) {
    promises.push(pipeline.dispatch('debug.quick_success', { id: i }))
  }

  await Promise.all(promises)

  const end = performance.now()
  console.log(`å®Œæˆ 1000 ä¸ªè¯·æ±‚ï¼Œè€—æ—¶: ${end - start}ms`)

  // æ‰“å¼€æµè§ˆå™¨ä»»åŠ¡ç®¡ç†å™¨ï¼ˆShift + Escï¼‰
  // è§‚å¯Ÿ CPU å ç”¨ç‡
}

stressTest()
```

**ç»“æœ**ï¼š

- æ€»è€—æ—¶ï¼š~200-500ms
- CPU å³°å€¼ï¼š< 10%
- å†…å­˜å¢é•¿ï¼š< 5MB
- **UI ä»ç„¶æµç•…** âœ…

---

## ğŸ”¥ çœŸæ­£ä¼šé˜»å¡çš„æƒ…å†µ

### âŒ æƒ…å†µ 1: åŒæ­¥ CPU å¯†é›†å‹æ“ä½œ

```typescript
async function badExample() {
  await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' }) // âœ… ä¸é˜»å¡

  // âŒ è¿™ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼
  for (let i = 0; i < 1000000000; i++) {
    Math.sqrt(i) // CPU å¯†é›†å‹è®¡ç®—
  }

  // åœ¨ä¸Šé¢çš„å¾ªç¯æœŸé—´ï¼š
  // - UI å†»ç»“ âŒ
  // - ç‚¹å‡»æ— å“åº” âŒ
  // - åŠ¨ç”»åœæ­¢ âŒ
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Web Worker

```typescript
// åœ¨ Worker ä¸­æ‰§è¡Œ CPU å¯†é›†å‹æ“ä½œ
const worker = new Worker('heavy-work.js')
worker.postMessage(data)

worker.onmessage = (e) => {
  console.log('Worker å®Œæˆ', e.data)
}

// ä¸»çº¿ç¨‹ç»§ç»­è¿è¡Œ âœ…
```

### âŒ æƒ…å†µ 2: å¤§é‡åŒæ­¥ DOM æ“ä½œ

```typescript
async function badExample() {
  await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' }) // âœ… ä¸é˜»å¡

  // âŒ è¿™ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼
  for (let i = 0; i < 10000; i++) {
    document.body.appendChild(document.createElement('div'))
  }

  // åœ¨ä¸Šé¢çš„å¾ªç¯æœŸé—´ï¼šUI å†»ç»“ âŒ
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `requestAnimationFrame` åˆ†æ‰¹å¤„ç†

```typescript
async function goodExample() {
  await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' })

  // âœ… åˆ†æ‰¹æ’å…¥ï¼Œä¸é˜»å¡ UI
  for (let i = 0; i < 10000; i++) {
    document.body.appendChild(document.createElement('div'))

    if (i % 100 === 0) {
      await new Promise((resolve) => requestAnimationFrame(resolve))
      // è®©å‡ºä¸»çº¿ç¨‹ï¼Œæ¸²æŸ“ UI
    }
  }
}
```

---

## ğŸ¯ CPU Pipeline çš„å¼‚æ­¥è®¾è®¡

### å…¨æµç¨‹å¼‚æ­¥åˆ†æ

```typescript
// ç”¨æˆ·æ“ä½œ
await pipeline.dispatch('task.create', { title: 'ä»»åŠ¡' })
  â”‚
  â†“ (< 1ms CPU)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF: fetchInstruction()                  â”‚
â”‚   - åˆ›å»ºå¯¹è±¡                             â”‚
â”‚   - ç”Ÿæˆ ID                              â”‚
â”‚   - CPU: < 0.1ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“ (< 1ms CPU)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCH: tick()                             â”‚
â”‚   - æ£€æµ‹èµ„æºå†²çª                         â”‚
â”‚   - æ›´æ–°é˜Ÿåˆ—                             â”‚
â”‚   - CPU: < 0.1ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“ (1-5ms CPU)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EX: ä¹è§‚æ›´æ–°                             â”‚
â”‚   - æ·±æ‹·è´å¯¹è±¡                           â”‚
â”‚   - æ›´æ–° Pinia store                    â”‚
â”‚   - CPU: 0.1-1ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“ (< 1ms CPU)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EX: executeRequest()                    â”‚
â”‚   - è°ƒç”¨ fetch API                      â”‚
â”‚   - äº¤ç»™æµè§ˆå™¨åº•å±‚                       â”‚
â”‚   - CPU: < 0.1ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“ (0ms CPU, 50-500ms ç½‘ç»œç­‰å¾…)  â† ğŸ”¥ å…³é”®ï¼šä¸å ç”¨ CPU
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµè§ˆå™¨åº•å±‚ï¼ˆC++ï¼‰                        â”‚
â”‚   - å‘é€ HTTP è¯·æ±‚                      â”‚
â”‚   - ç­‰å¾…æœåŠ¡å™¨å“åº”                       â”‚
â”‚   - æ¥æ”¶æ•°æ®                             â”‚
â”‚   - CPU: 0msï¼ˆJavaScript ä¸å‚ä¸ï¼‰ âœ…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â†“ (1-5ms CPU)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WB: commit()                            â”‚
â”‚   - æ›´æ–° Pinia store                    â”‚
â”‚   - æ³¨å†Œåˆ° INT                           â”‚
â”‚   - CPU: 0.1-1ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€» CPU æ—¶é—´ï¼š< 10ms âœ…
æ€»è€—æ—¶ï¼š50-500ms
CPU å ç”¨ç‡ï¼š< 2% âœ…
```

---

## ğŸ‰ ç»“è®º

### âœ… `await pipeline.dispatch()` ä¸ä¼šé˜»å¡

1. **ä¸é˜»å¡ä¸»çº¿ç¨‹**
   - `await` æš‚åœå½“å‰å‡½æ•°
   - ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡
   - äº‹ä»¶å¾ªç¯æ­£å¸¸è¿è¡Œ

2. **ä¸é˜»å¡ UI**
   - ç‚¹å‡»å“åº”
   - åŠ¨ç”»æµç•…
   - æ»šåŠ¨æ­£å¸¸
   - æ¸²æŸ“ä¸å—å½±å“

3. **ä¸å ç”¨ CPU**
   - ç½‘ç»œç­‰å¾…æœŸé—´ CPU å ç”¨ 0%
   - åªæœ‰åŒæ­¥ä»£ç æ‰§è¡Œæ—¶å ç”¨ CPU
   - æ€» CPU æ—¶é—´ < 10ms

4. **é«˜æ€§èƒ½**
   - å¯å¹¶å‘æ‰§è¡Œ 1000+ æŒ‡ä»¤
   - CPU å ç”¨ç‡ < 10%
   - å†…å­˜å ç”¨åˆç†

### ğŸ¯ æ ¸å¿ƒåŸç†

**JavaScript æ˜¯å•çº¿ç¨‹ï¼Œä½†æœ‰å¼‚æ­¥ I/O**

```
åŒæ­¥ä»£ç           â† CPU å ç”¨ï¼Œä¼šé˜»å¡
  â†“
await ç½‘ç»œè¯·æ±‚    â† ä¸å ç”¨ CPUï¼Œä¸é˜»å¡ âœ…
  â†“
åŒæ­¥ä»£ç           â† CPU å ç”¨ï¼Œä¼šé˜»å¡
```

**ç½‘ç»œè¯·æ±‚ç”±æµè§ˆå™¨åº•å±‚ï¼ˆC++ï¼‰å¤šçº¿ç¨‹å¤„ç†**ï¼ŒJavaScript ä¸»çº¿ç¨‹å®Œå…¨ç©ºé—²ï¼

---

## ğŸ’¡ å®ç”¨å»ºè®®

1. **æ”¾å¿ƒä½¿ç”¨ `await pipeline.dispatch()`**
   - ä¸ä¼šé˜»å¡ UI
   - ä¸ä¼šå ç”¨ CPU
   - ä»£ç æ›´æ¸…æ™°

2. **é¿å…åœ¨ async å‡½æ•°ä¸­æ‰§è¡Œ CPU å¯†é›†æ“ä½œ**

   ```typescript
   async function bad() {
     await pipeline.dispatch(...)  // âœ… ä¸é˜»å¡

     for (let i = 0; i < 1e9; i++) {  // âŒ ä¼šé˜»å¡
       Math.sqrt(i)
     }
   }
   ```

3. **å¹¶å‘æ—¶ä½¿ç”¨ `Promise.all`**

   ```typescript
   // âœ… å¥½ï¼šå¹¶å‘æ‰§è¡Œ
   await Promise.all([
     pipeline.dispatch('task.create', { title: 'A' }),
     pipeline.dispatch('task.create', { title: 'B' }),
   ])

   // âŒ å·®ï¼šä¸²è¡Œæ‰§è¡Œï¼ˆè™½ç„¶ä¸é˜»å¡ï¼Œä½†æ…¢ï¼‰
   await pipeline.dispatch('task.create', { title: 'A' })
   await pipeline.dispatch('task.create', { title: 'B' })
   ```

4. **ç›‘æ§ CPU å ç”¨**
   ```typescript
   // æ‰“å¼€æµè§ˆå™¨ä»»åŠ¡ç®¡ç†å™¨ï¼ˆShift + Escï¼‰
   // ç›‘æ§ JavaScript è¿›ç¨‹çš„ CPU å ç”¨
   // æ­£å¸¸åº”è¯¥ < 10%
   ```

---

**æ€»ç»“**ï¼š`await pipeline.dispatch()` æ˜¯å®Œå…¨å®‰å…¨çš„ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹æˆ–å ç”¨ CPUï¼ğŸš€
