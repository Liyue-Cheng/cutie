#### **第六部分：网络/路由层 (Network / Router Layer)**

- 层级定义书 (CABC for Layer):
  - **预期行为简介:** 本层是Cutie后端服务的唯一入口。它负责监听HTTP请求，解析并验证这些请求，调用相应的`服务层`方法来执行业务逻辑，最后将`服务层`的成功或失败结果，序列化成标准、一致的HTTP响应返回给客户端。
  - 输入输出规范:
    - **前置条件:** 所有进入的HTTP请求都必须遵循OpenAPI文档定义的路径、方法、参数和请求体结构。
    - **后置条件:** 所有发出的HTTP响应都必须遵循OpenAPI文档定义的响应码和响应体结构。
  - 不变量:
    - 本层**绝对不能**包含任何业务逻辑。它的职责是纯粹的“翻译”和“调度”：`HTTP <-> 服务层调用`。
    - 本层**必须**将所有来自`服务层`的`AppError`，映射为清晰、一致的HTTP状态码。
    - 所有API端点都必须有明确的身份验证和授权检查（即使V1.0是单机版，也应预留此中间件层）。
    - 所有响应体（尤其是错误响应）的JSON结构必须保持一致。

------

#### **1. 统一错误响应映射 (Error-to-HTTP Mapping)**

- **预期行为简介:** 定义一个全局的规则，将`服务层`返回的`AppError`枚举，转换为标准的HTTP错误响应。
- 规范:
  - `AppError::DatabaseError` -> `500 Internal Server Error`
  - `AppError::UnspecifiedInternalError` -> `500 Internal Server Error`
  - `AppError::NotFound` -> `404 Not Found`
  - `AppError::ValidationFailed` -> `422 Unprocessable Entity` (或 `400 Bad Request`)，响应体中必须包含详细的字段错误信息。
  - `AppError::PermissionDenied` -> `403 Forbidden`
  - `AppError::Conflict` -> `409 Conflict`
  - `AppError::ExternalDependencyFailed` -> `503 Service Unavailable`
- **实现:** 这通常通过一个`axum`或`actix-web`的中间件或自定义的`IntoResponse` trait实现来完成，确保所有错误处理逻辑是集中且统一的。

------

#### **2. V1.0 API端点清单与CABC (OpenAPI 风格)**

*(以下为部分核心API的详细定义，作为完整OpenAPI文档的示例)*

##### **模块: Tasks**

- **端点:** `POST /tasks`
  - **函数签名 (Handler):** `pub async fn create_task_handler(State<AppState>, Json<CreateTaskPayload>) -> Result<Json<Task>, AppError>`
  - **预期行为简介 (summary):** 在指定的上下文中创建一个新任务。
  - 输入规范 (requestBody):
    - `content-type`: `application/json`
    - `schema`: `CreateTaskPayload`，包含`title`, `glance_note` (optional), `detail_note` (optional), `context`等字段。`context`是一个描述创建位置的对象。
  - 后置条件 (responses):
    - `201 Created`: 成功创建。响应体为新创建的`Task`对象的完整JSON。
    - `422 Unprocessable Entity`: 输入数据验证失败（如`title`为空）。
    - `404 Not Found`: `context`中指定的实体（如`project_id`）不存在。
  - **预期副作用:** 调用`TaskService::create_in_context`。
- **端点:** `POST /tasks/{id}/completion`
  - **函数签名 (Handler):** `pub async fn complete_task_handler(State<AppState>, Path<Uuid>) -> Result<Json<Task>, AppError>`
  - **预期行为简介 (summary):** 全局完成一个任务。
  - **输入规范 (parameters):** `id` (path, UUID) - 要完成的任务ID。
  - 后置条件 (responses):
    - `200 OK`: 成功完成或任务本就已完成（幂等）。响应体为更新后的`Task`对象。
    - `404 Not Found`: 任务不存在。
  - **预期副作用:** 调用`TaskService::complete_task`，可能触发大量数据库写操作和WebSocket推送。

------

##### **模块: Schedules**

- **端点:** `POST /schedules`
  - **函数签名 (Handler):** `pub async fn schedule_task_handler(State<AppState>, Json<ScheduleTaskPayload>) -> Result<Json<TaskSchedule>, AppError>`
  - **预期行为简介 (summary):** 安排一个任务到某一天，支持“移动”或“链接”模式。
  - 输入规范 (requestBody):
    - `schema`: `ScheduleTaskPayload`，包含`task_id`和`target_day`，以及一个区分`move`或`link`的模式字段。
  - 后置条件 (responses):
    - `201 Created` (for link) / `200 OK` (for move): 操作成功。响应体为新创建或更新后的`TaskSchedule`对象。
    - `409 Conflict`: 任务已完成，无法安排。
    - `404 Not Found`: 任务或（在move模式下）源日程不存在。
  - **预期副作用:** 调用`ScheduleService::schedule_task`。
- **端点:** `DELETE /schedules/tasks/{taskId}`
  - **函数签名 (Handler):** `pub async fn unschedule_task_completely_handler(State<AppState>, Path<Uuid>) -> Result<StatusCode, AppError>`
  - **预期行为简介 (summary):** 将一个任务从所有日程中移除，使其回归Staging。
  - **输入规范 (parameters):** `taskId` (path, UUID)。
  - 后置条件 (responses):
    - `204 No Content`: 操作成功。
    - `404 Not Found`: 任务不存在。
  - **预期副作用:** 调用`ScheduleService::unschedule_task_completely`。

------

##### **模块: Ordering**

- 端点:

  ```
  PUT /ordering
  ```

  - **函数签名 (Handler):** `pub async fn update_order_handler(State<AppState>, Json<UpdateOrderPayload>) -> Result<StatusCode, AppError>`
  - **预期行为简介 (summary):** 更新一个任务在一个特定上下文中的排序位置。
  - 输入规范 (requestBody):
    - `schema`: `UpdateOrderPayload`，包含`context_type`, `context_id`, `task_id`, `new_sort_order`。
  - 后置条件 (responses):
    - `204 No Content`: 排序更新成功。
    - `422 Unprocessable Entity`: 输入的上下文或排序值无效。
  - **预期副作用:** 调用`OrderingService::update_order`。

------

##### **模块: AI Services** (虽然在服务层实现，但也需定义API)

- 端点:

  ```
  POST /ai/refine-task
  ```

  - **预期行为简介 (summary):** 为一个任务生成一系列子任务（“少女的明信片”）。
  - **输入规范 (requestBody):** 包含`task_id`和可选的`prompt_key`。
  - 后置条件 (responses):
    - `200 OK`: 成功细化。响应体为**更新后**的完整`Task`对象（包含了新的`subtasks`）。
    - `503 Service Unavailable`: AI服务调用失败。
  - **预期副作用:** 调用`AiService`，然后调用`TaskService::update_task`。

------

导演，这份**网络/路由层**的定义书，为我们V1.0需要实现的核心API提供了清晰的“契约”。它明确了每个端点的职责、输入输出和预期的行为。