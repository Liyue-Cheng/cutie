### **《Cutie后端设计纲要》V1.0**

#### **第一部分：核心领域模型层 (Core Domain Model Layer)**

*   **层级定义书 (CABC for Layer):**
    *   **预期行为简介:** 本层定义了Cutie业务世界中所有核心实体的静态数据结构。它们是系统中“通用语言”的基础，是所有上层逻辑操作的对象。本层代码不包含任何业务逻辑，只有纯粹的数据定义。
    *   **不变量:**
        *   本层所有结构体都必须是可序列化和反序列化 (`Serialize`, `Deserialize`) 的。
        *   所有ID字段必须使用`UUID`类型。
        *   所有时间戳字段必须使用带时区的UTC时间 (`DateTime<Utc>`)。
        *   所有可能不存在的字段必须使用`Option<T>`（在数据库中表现为`nullable`）。
        *   所有与数据库表直接映射的实体，其字段名和类型必须与V1.8 Schema定义严格一致。

---

#### **1. `Task` (任务) 实体定义书**

*   **结构签名:** `pub struct Task { ... }`
*   **预期行为简介:** 代表一个用户需要完成的具体待办事项。它是系统中进行规划、调度和执行的基本原子单位。
*   **字段规范:**
    *   `id` (UUID, 主键):
        *   **前置条件:** 必须是V4或V7格式的UUID。创建后不可更改。
        *   **不变量:** 在`Task`的整个生命周期中，`id`永远不变。
    *   `title` (String):
        *   **前置条件:** 创建时不能为空字符串。长度必须在1到255个字符之间。
        *   **后置条件:** 代表任务的核心描述。
    *   `glance_note` (String, nullable):
        *   **前置条件:** 长度（如果存在）建议不超过140个字符。
        *   **后置条件:** 用于在卡片视图上提供快速上下文，是纯文本。
    *   `detail_note` (String, nullable):
        *   **前置条件:** 无特定长度限制。
        *   **后置条件:** 用于存储任务的详细信息，支持Markdown格式。
    *   `estimated_duration` (Integer, nullable):
        *   **前置条件:** 必须是正整数。
        *   **后置条件:** 代表预估完成任务所需的分钟数。特殊值`1`被前端解释为“Tiny”。
    *   `subtasks` (JSON, nullable):
        *   **前置条件:** 必须是`Vec<Subtask>`的JSON序列化形式，其中`Subtask`结构为`{ id: UUID, title: String, is_completed: Boolean, sort_order: String }`。`sort_order`用于子任务排序。
    *   `project_id` (UUID, nullable, 外键):
        *   **前置条件:** 如果非`NULL`，必须指向一个存在的`Project.id`。
    *   `area_id` (UUID, nullable, 外键):
        *   **前置条件:** 如果非`NULL`，必须指向一个存在的`Area.id`。
    *   `due_date` (Timestamp, nullable):
        *   **前置条件:** 如果非`NULL`，`due_date_type`也必须非`NULL`。
    *   `due_date_type` (Enum: `SOFT`, `HARD`, nullable):
        *   **前置条件:** 只有在`due_date`非`NULL`时才能有值。
    *   `completed_at` (Timestamp, nullable):
        *   **不变量:** 此字段的值是判断任务是否完成的**唯一依据**。`IS NOT NULL`意味着已完成。
    *   `created_at` (Timestamp):
        *   **不变量:** 创建后不可更改。
    *   `updated_at` (Timestamp, INDEXED):
        *   **后置条件:** 每当任务记录发生任何修改时，此字段必须被更新为当前时间。
    *   `is_deleted` (Boolean, 默认 `false`, INDEXED):
        *   **后置条件:** 逻辑删除标记。当为`true`时，该任务对用户不可见。
    *   (所有`source_info`, `external_...`, `recurrence_...`字段遵循其各自的格式和逻辑约束)

---

#### **2. `TimeBlock` (时间块) 实体定义书**

*   **结构签名:** `pub struct TimeBlock { ... }`
*   **预期行为简介:** 代表日历上的一个有明确开始和结束时间的持续性时间段。
*   **字段规范:**
    *   `id` (UUID, 主键): (同`Task.id`约束)
    *   `title` (String, nullable):
        *   **后置条件:** 如果存在，它将覆盖掉关联任务的标题，作为时间块的独立主题。
    *   `glance_note` / `detail_note`: (同`Task`的note约束)
    *   `start_time` (Timestamp, NOT NULL):
        *   **不变量:** `start_time`必须永远小于或等于`end_time`。
    *   `end_time` (Timestamp, NOT NULL):
        *   **不变量:** `end_time`必须永远大于或等于`start_time`。
    *   `area_id` (UUID, nullable, 外键):
        *   **后置条件:** 决定此时间块在日历上的染色。它的值独立于其关联的任何`Task`的`area_id`。
    *   (所有同步、API、重复任务字段同`Task`表的定义)

---

#### **3. `Area` (领域) 实体定义书**

*   **结构签名:** `pub struct Area { ... }`
*   **预期行为简介:** 代表一个用户自定义的、用于分类和染色的结构化标签。
*   **字段规范:**
    *   `id` (UUID, 主键): (同`Task.id`约束)
    *   `name` (String):
        *   **前置条件:** 不能为空。建议在同一层级下保持唯一。
    *   `color` (String):
        *   **前置条件:** 必须是有效的十六进制颜色码字符串 (e.g., `#RRGGBB`)。
    *   `parent_area_id` (UUID, nullable, 自关联):
        *   **前置条件:** 如果非`NULL`，必须指向一个存在的`Area.id`。
        *   **不变量:** 一个Area不能将自己或自己的子孙Area设为父节点，以防止循环依赖。

---

#### **4. `Template` (模板) 实体定义书**

*   **结构签名:** `pub struct Template { ... }`
*   **预期行为简介:** 一个用于快速创建新`Task`的预设配置。
*   **字段规范:**
    *   `id` (UUID, 主键): (同`Task.id`约束)
    *   `name` (String):
        *   **前置条件:** 不能为空，用于在模板列表中展示。
    *   `..._template` 字段:
        *   **后置条件:** 这些字段（如`title_template`, `subtasks_template`）定义了当使用此模板创建`Task`时，新`Task`对应字段的初始值。它们可能包含特定的模板变量（如`{{date}}`），由服务层在实例化时进行解析和替换。

---

#### **5. `Task_Schedule` (任务日程) 实体定义书**

*   **结构签名:** `pub struct Task_Schedule { ... }`
*   **预期行为简介:** 一条关联记录，精确定义了一个`Task`在哪一天被安排，以及它在那一天的最终“结局”。
*   **字段规范:**
    *   `id` (UUID, 主键): (同`Task.id`约束)
    *   `task_id` (UUID, NOT NULL, 外键):
        *   **不变量:** 必须永远指向一个有效的、未被物理删除的`Task`。
    *   `scheduled_day` (Timestamp, NOT NULL, INDEXED):
        *   **前置条件:** 必须是当日的零点零分零秒（UTC）。
    *   `outcome` (Enum: `PLANNED`, `PRESENCE_LOGGED`, `COMPLETED_ON_DAY`, `CARRIED_OVER`):
        *   **后置条件:** 忠实记录当日的结局，**不应**被未来发生的事件（如任务的全局完成）追溯修改。

---

#### **6. `Ordering` (排序) 实体定义书**

*   **结构签名:** `pub struct Ordering { ... }`
*   **预期行为简介:** 一条关联记录，定义了一个`Task`在某个特定“上下文”中的显示顺序。
*   **字段规范:**
    *   `id` (UUID, 主键): (同`Task.id`约束)
    *   `context_type` (Enum: `DAILY_KANBAN`, `PROJECT_LIST`, `AREA_FILTER`, `MISC`):
        *   **不变量:** `context_type`和`context_id`的组合必须唯一地标识一个可排序的视图。
    *   `context_id` (String, INDEXED):
        *   **前置条件:** 必须遵循已定义的规范化格式。
    *   `sort_order` (String, INDEXED):
        *   **前置条件:** 必须是符合LexoRank或类似算法格式的有效排序字符串。
