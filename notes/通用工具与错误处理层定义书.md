### **《Cutie后端设计纲要》V1.0 (修正版)**

#### **第二部分：通用工具与错误处理层 (Common Utilities & Error Handling Layer)**

*   **层级定义书 (CABC for Layer):**
    *   **预期行为简介:** 本层提供被整个应用程序复用的基础工具和统一的错误处理模型。它旨在减少代码重复，并为所有其他层级提供一套标准的、可预测的、用于表示失败和执行通用计算的机制。
    *   **输入输出规范:**
        *   **前置条件:** 调用本层工具函数的输入必须满足其各自的类型和格式要求。
        *   **后置条件:** 本层函数要么返回一个预期的、正确计算的结果，要么返回一个代表了失败原因的、明确的错误类型。
    *   **不变量:**
        *   本层代码**不**包含任何特定领域的业务逻辑（如`Task`或`Project`相关的规则）。
        *   本层代码**不**直接进行数据库或网络I/O操作。
        *   本层代码**不**依赖于`服务层`或`仓库层`。

---

#### **1. `AppError` (统一应用错误) 定义书**

*   **结构签名:** `pub enum AppError { ... }`
*   **预期行为简介:** 这是在Cutie后端**业务逻辑执行过程**中，可能发生的、所有可预见的、具有明确业务含义的错误的集合。它是`服务层`向`路由层`传递失败信息的标准方式。
*   **字段（变体）规范:**
    *   `DatabaseError(DbError)`:
        *   **预期行为:** 表示一个源自`仓库层`的、无法恢复的数据库操作失败。
        *   **后置条件:** 包含原始的`DbError`，以便上层进行日志记录。
    *   `NotFound { entity_type: String, entity_id: String }`:
        *   **预期行为:** 表示一个基于唯一标识符的查找操作没有找到对应的实体。
        *   **后置条件:** `entity_type`和`entity_id`清晰地指明了哪个实体未被找到。
    *   `ValidationFailed(Vec<ValidationError>)`:
        *   **预期行为:** 表示一个或多个输入参数未能通过业务规则的验证。
        *   **后置条件:** `Vec<ValidationError>`详细列出了所有验证失败的字段及其原因。
    *   `PermissionDenied`:
        *   **预期行为:** 表示当前操作因权限不足而被拒绝。
    *   `Conflict { message: String }`:
        *   **预期行为:** 表示当前操作因与系统现有状态发生冲突而无法完成（例如，唯一性约束冲突）。
    *   `ExternalDependencyFailed { service_name: String, error_message: String }`:
        *   **预期行为:** 表示一个对外部依赖（如AI服务）的调用失败。
    *   `UnspecifiedInternalError`:
        *   **预期行为:** 表示一个在业务逻辑中发生的、未被其他变体覆盖的内部错误。

*   **不变量:** `AppError`本身不包含任何关于HTTP状态码的知识。它只负责**描述业务层面的失败**。将`AppError`映射到具体的HTTP状态码是`路由层`的职责。

---

#### **2. `utils` 模块定义书**

*   **预期行为简介:** 提供一系列确定性的、无副作用的纯函数工具集。
*   **包含的子模块/功能:**
    *   **`time_utils`:**
        *   **预期行为:** 封装所有与`DateTime<Utc>`相关的、不依赖当前系统时间的计算。
        *   **后置条件:** 对于给定的`DateTime`输入，总是返回一个可预测的、正确计算后的`DateTime`输出。
        *   **边界情况:** 必须能正确处理闰年、时区转换（虽然我们统一用UTC）、以及月份边界。
    *   **`sort_order_utils`:**
        *   **预期行为:** 实现一个确定性的排序字符串生成算法（如LexoRank的简化版）。
        *   **后置条件:** `get_mid_lexo_rank("a", "c")`必须总是返回一个介于"a"和"c"之间的字符串（如"b"）。
        *   **边界情况:** 必须能正确处理在列表头部、尾部插入，以及两个相邻字符串之间没有空间时的情况。
    *   **`template_utils`:**
        *   **预期行为:** 实现一个简单的、基于键值对的模板字符串替换。
        *   **后置条件:** `render_template("Hello, {{name}}", {"name": "World"})`必须返回"Hello, World"。
        *   **边界情况:** 必须能正确处理模板中存在未提供值的变量（保留原样或替换为空字符串），以及模板中不存在的变量被提供的情况。

---

#### **3. `logger` 模块定义书**

*   **预期行为简介:** 提供一个全局单例的日志记录器配置入口。
*   **包含的子模块/功能:**
    *   **`init_logger()` 函数:**
        *   **预期行为:** 根据输入参数（如日志级别、格式），配置并初始化一个全局的日志记录器。
        *   **后置条件:** 成功调用后，整个应用后续的`log::info!`, `log::error!`等宏调用，都会按照此配置进行输出。
        *   **预期副作用:** 这是一个全局状态修改操作，会注册一个全局的`Log` trait实现。它在应用的生命周期中**只应被调用一次**。
        *   **边界情况:** 如果重复调用，应有一个明确的行为（例如，panic或返回一个错误），以防止意外的重置配置。
