# Cutie 后端旧代码库审查清单 V1.2 (深度风险审计版)

**审查文件:** `[填写要审查的文件路径，如：src/repositories/sqlx_task_repository.rs]`
**审查员:** `[您的名字]`
**审查日期:** `YYYY-MM-DD`
**审查结论:** [ ] 健康 | [ ] 存在风险 | [ ] 需要立即重构

---

## 第一部分：代码基础质量与规范审查

*   **目标:** 检查代码是否符合基本的编码规范和可读性要求。

| 检查项                                                       | 状态             | 备注 / 发现的问题 |
| :----------------------------------------------------------- | :--------------- | :---------------- |
| **1.1. 命名规范:** 函数、变量、结构体的命名是否清晰、符合Rust社区规范，且没有令人困惑的缩写？ | [ ] Yes / [ ] No |                   |
| **1.2. 格式化:** 代码是否经过了`cargo fmt`格式化？           | [ ] Yes / [ ] No |                   |
| **1.3. 注释与文档:** 是否有必要的`//`行注释来解释复杂的代码块？是否有基础的`///`文档注释解释公共函数的作用？ | [ ] Yes / [ ] No |                   |
| **1.4. 模块化与职责:** 文件内的函数和结构体是否职责单一？是否存在一个函数做了太多不相干的事情？ | [ ] Yes / [ ] No |                   |
| **1.5. "魔法数字"与硬编码:** 代码中是否存在未加说明的“魔法数字”或硬编码的字符串？ | [ ] Yes / [ ] No |                   |

---

## 第二部分：健壮性与错误处理审查

*   **目标:** 发现代码中常见的“想当然”的错误、潜在的崩溃点和不健壮的实现。

| 检查项                                                       | 状态             | 备注 / 发现的问题                                            |
| :----------------------------------------------------------- | :--------------- | :----------------------------------------------------------- |
| **2.1. 致命的`unwrap()`/`expect()`:** 代码中是否存在任何可能在运行时因为合法输入或外部状态变化而导致`panic`的`unwrap()`或`expect()`调用？ | [ ] Yes / [ ] No | **危险信号:** `my_option.unwrap()`, `my_result.expect("this should never fail")` |
| **2.2. 错误处理:** 所有返回`Result`或`Option`的调用，其`Err`或`None`分支是否都得到了妥善处理？是否存在被忽略的错误？ | [ ] Yes / [ ] No | **危险信号:** `let _ = some_fallible_operation();`           |
| **2.3. 外部环境假设:**<br>- **文件/路径:** 代码是否假设某个文件或目录路径一定存在？<br>- **数据库:** 代码是否假设数据库文件一定存在且结构正确？ | [ ] Yes / [ ] No | *应有的行为：自动创建文件/DB，或返回一个优雅的错误。*        |
| **2.4. 资源管理:** 数据库连接、文件句柄等资源是否被正确管理和释放？ | [ ] Yes / [ ] No | *RAII通常能保证，但需警惕手动管理或循环引用的情况。*         |
| **2.5. 克隆 (`.clone()`) 的使用:** 是否存在不必要的、可能引发性能问题的`.clone()`调用？特别是在循环中。 | [ ] Yes / [ ] No |                                                              |

---

## 第三部分：架构与设计原则审查

*   **目标:** 评估当前代码是否遵循了核心架构原则，识别出重构的重点和难点。

| 检查项                                                       | 状态             | 备注 / 发现的问题                                            |
| :----------------------------------------------------------- | :--------------- | :----------------------------------------------------------- |
| **3.1. 分层职责泄漏:**<br>- **`Repository`层:** 是否包含了业务逻辑（如`if/else`判断）？<br>- **`Service`层:** 是否包含了SQL语句或直接的数据库驱动调用？<br>- **`Handler`层:** 是否包含了业务逻辑？ | [ ] Yes / [ ] No | **危险信号:** `Repository`中出现非数据验证的`if`判断；`Service`中出现`sqlx::query!...`。 |
| **3.2. 事务管理与数据一致性:**<br>- **事务边界:** 跨多个写操作的业务逻辑，其事务的开启和提交是否在`Service`层完成？<br>- **【关键】事务内连接一致性:** 在一个接受`&mut Transaction`的方法内部，是否存在任何对`self.pool`的调用，或调用了其他不接受`tx`作为参数的、会访问数据库的`self`方法？ | [ ] Yes / [ ] No | **危险信号 (高危):**<br> `async fn my_method(&self, tx: &mut Tx, ...)`<br> `  // ... 一些使用tx的操作 ...`<br> `  let data = self.find_by_id(id).await?; // ❌ 这是一个巨大的陷阱！find_by_id内部很可能用了self.pool` |
| **3.3. 依赖注入 (DFT) 遵循情况:**<br>- **硬编码外部依赖:** 代码中是否存在直接调用`Utc::now()`, `Uuid::new_v4()`, `rand::random()`等不确定性函数的硬编码？<br>- **可替换性:** 代码结构是否难以在测试中用Mock对象替换真实依赖？ | [ ] Yes / [ ] No | **危险信号:** 在业务逻辑函数内部看到任何`::now()`或`::new_v4()`。 |
| **3.4. “变通方案”(Workarounds) 与技术债:** 是否存在看起来很奇怪的、像是为了“绕过某个问题”而写的临时性代码？是否留下了`// TODO:`, `// HACK:`, `// FIXME:`等注释？ | [ ] Yes / [ ] No | *所有这些都应被记录下来，作为重构时需要解决的问题。*         |

---

## 第四部分：安全漏洞初步排查

*   **目标:** 进行一次快速的安全扫描，发现最常见的安全风险。

| 检查项                                                       | 状态             | 备注 / 发现的问题                                            |
| :----------------------------------------------------------- | :--------------- | :----------------------------------------------------------- |
| **4.1. SQL注入风险:** 是否所有SQL查询都使用了参数化绑定？是否存在任何形式的字符串拼接来构造SQL？ | [ ] Yes / [ ] No | **危险信号:** `format!("SELECT * FROM users WHERE name = '{}'", user_name)` |
| **4.2. 信息泄露:** 错误处理或日志记录中，是否可能将敏感信息（API Keys, 密码, 文件路径, 详细的数据库错误）暴露给用户或不安全的日志目标？ | [ ] Yes / [ ] No |                                                              |
| **4.3. 输入验证:** 在处理来自外部的数据时，代码是否对输入进行了充分的验证？还是盲目地信任了输入？ | [ ] Yes / [ ] No |                                                              |

---

### **审查总结与重构建议**

*   **[在此处填写对该文件的总体评价。例如：`sqlx_task_repository.rs` 文件结构清晰，但在事务管理（3.2）上存在严重的数据一致性风险，必须立即修复。同时，在`create`方法中发现了硬编码的UUID生成（3.3）。]**

### **识别出的高优风险与行动项 (Action Items)**

1.  **[高危风险 - 事务隔离]:** 在`set_completed`方法中，更新后的查询使用了独立的连接池，导致无法读取未提交的数据。**行动项:** 必须重构此方法，确保所有读写操作都通过传入的事务句柄`tx`执行。
2.  **[中等风险 - 硬编码依赖]:** 在`create`方法中，直接调用了`Uuid::new_v4()`。**行动项:** 必须重构，改为从注入的`IdGenerator`服务获取ID。
3.  **[低风险 - 代码可读性]:** `some_complex_query`方法缺少注释，难以理解其意图。**行动项:** 补充详细的注释，解释其逻辑。
4.  **...**