# æ‹–æ”¾ç­–ç•¥ç³»ç»Ÿ - å®Œæ•´å®ç°æŠ¥å‘Š

## ğŸ“Š å®ç°æ€»ç»“

å·²å®Œæˆå…¨æ–°çš„æ‹–æ”¾ç­–ç•¥ç³»ç»Ÿå®ç°ï¼Œé‡‡ç”¨å£°æ˜å¼è®¾è®¡ï¼Œå®Œå…¨é‡å†™ï¼Œä¸æ—§ç³»ç»Ÿæ— å…¼å®¹å…³ç³»ã€‚

## âœ… å®Œæˆæ¸…å•

### æ ¸å¿ƒæ¡†æ¶

- [x] **ç±»å‹å®šä¹‰** (`src/infra/drag/types.ts`)
  - DragSession - æ‹–æ”¾ä¼šè¯
  - StrategyCondition - ç­–ç•¥æ¡ä»¶
  - StrategyAction - ç­–ç•¥åŠ¨ä½œ
  - StrategyResult - æ‰§è¡Œç»“æœ
  - å®Œæ•´çš„ TypeScript ç±»å‹æ”¯æŒ

- [x] **ç­–ç•¥æ³¨å†Œä¸­å¿ƒ** (`src/infra/drag/strategy-registry.ts`)
  - ç­–ç•¥æ³¨å†Œ/æ³¨é”€
  - æ‰¹é‡æ³¨å†Œ
  - ç­–ç•¥æŸ¥æ‰¾ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
  - æŒ‰æ ‡ç­¾æŸ¥æ‰¾
  - å¯ç”¨/ç¦ç”¨ç­–ç•¥
  - ç»Ÿè®¡ä¿¡æ¯
  - å¼€å‘å·¥å…·ï¼ˆdebugï¼‰

- [x] **ç­–ç•¥åŒ¹é…ç®—æ³•** (`src/infra/drag/strategy-matcher.ts`)
  - æºè§†å›¾æ¡ä»¶åŒ¹é…
  - ç›®æ ‡è§†å›¾æ¡ä»¶åŒ¹é…
  - æ”¯æŒç²¾ç¡®åŒ¹é…å’Œæ­£åˆ™åŒ¹é…
  - è‡ªå®šä¹‰æ£€æŸ¥å‡½æ•°
  - åŒ¹é…å¾—åˆ†è®¡ç®—ï¼ˆé¢„ç•™ï¼‰

- [x] **ç­–ç•¥æ‰§è¡Œå¼•æ“** (`src/infra/drag/strategy-executor.ts`)
  - ç­–ç•¥æŸ¥æ‰¾å’ŒéªŒè¯
  - å‰ç½®æ£€æŸ¥ï¼ˆcanExecuteï¼‰
  - æ‰“å°æ¨¡å¼æ‰§è¡Œï¼ˆä¸æ‰§è¡Œå®é™…ä¸šåŠ¡ï¼‰
  - è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—
  - å®Œæ•´çš„æŒ‡ä»¤è¿½è¸ªé›†æˆ
  - è°ƒè¯•ä¿¡æ¯æ¥å£

### ç­–ç•¥å®ç°

- [x] **ä»»åŠ¡è°ƒåº¦ç­–ç•¥** (`src/infra/drag/strategies/task-scheduling.ts`)
  - staging-to-daily - æš‚å­˜åŒºåˆ°æ—¥ç¨‹ï¼ˆä¼˜å…ˆçº§ 100ï¼‰
  - daily-to-daily - æ—¥ç¨‹é—´ç§»åŠ¨ï¼ˆä¼˜å…ˆçº§ 90ï¼‰
  - daily-to-staging - é€€å›æš‚å­˜åŒºï¼ˆä¼˜å…ˆçº§ 95ï¼‰
  - staging-reorder - æš‚å­˜åŒºå†…æ’åºï¼ˆä¼˜å…ˆçº§ 80ï¼‰

### ç»„ä»¶é›†æˆ

- [x] **Vue Composable** (`src/composables/drag/useDragStrategy.ts`)
  - executeDrop - æ‰§è¡Œç­–ç•¥
  - previewDrop - é¢„è§ˆç­–ç•¥
  - hasStrategy - æ£€æŸ¥å¯ç”¨æ€§
  - getDebugInfo - è·å–è°ƒè¯•ä¿¡æ¯
  - å“åº”å¼çŠ¶æ€ï¼ˆisExecuting, lastResult, lastStrategyï¼‰

- [x] **åº”ç”¨åˆå§‹åŒ–** (`src/main.ts`)
  - å¯¼å…¥ç­–ç•¥ç³»ç»Ÿ
  - è°ƒç”¨ initializeDragStrategies()
  - è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ç­–ç•¥

- [x] **æµ‹è¯•é¡µé¢é›†æˆ** (`src/components/test/InteractKanbanColumn.vue`)
  - ä½¿ç”¨ useDragStrategy
  - åœ¨ onDrop å›è°ƒä¸­æ‰§è¡Œç­–ç•¥
  - æ˜¾ç¤ºæ‰§è¡Œç»“æœ

### æ–‡æ¡£

- [x] **README** (`src/infra/drag/README.md`)
  - å¿«é€Ÿå¼€å§‹æŒ‡å—
  - åˆ›å»ºæ–°ç­–ç•¥æ•™ç¨‹
  - ç­–ç•¥åŒ¹é…è§„åˆ™è¯´æ˜
  - è°ƒè¯•æŠ€å·§
  - å†…ç½®ç­–ç•¥åˆ—è¡¨
  - é«˜çº§ç”¨æ³•

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
æ–°å¢æ–‡ä»¶ï¼š

src/infra/drag/
â”œâ”€â”€ types.ts                    (276 è¡Œ) - ç±»å‹å®šä¹‰
â”œâ”€â”€ strategy-registry.ts        (218 è¡Œ) - æ³¨å†Œä¸­å¿ƒ
â”œâ”€â”€ strategy-matcher.ts         (180 è¡Œ) - åŒ¹é…ç®—æ³•
â”œâ”€â”€ strategy-executor.ts        (290 è¡Œ) - æ‰§è¡Œå¼•æ“
â”œâ”€â”€ index.ts                    (60 è¡Œ) - ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ README.md                   (400 è¡Œ) - å®Œæ•´æ–‡æ¡£
â””â”€â”€ strategies/
    â”œâ”€â”€ task-scheduling.ts      (240 è¡Œ) - è°ƒåº¦ç­–ç•¥
    â””â”€â”€ index.ts                (12 è¡Œ) - ç­–ç•¥å¯¼å‡º

src/composables/drag/
â””â”€â”€ useDragStrategy.ts          (100 è¡Œ) - ç»„ä»¶ API

ä¿®æ”¹æ–‡ä»¶ï¼š

src/main.ts                     (+2 è¡Œ) - å¯¼å…¥å’Œåˆå§‹åŒ–
src/components/test/InteractKanbanColumn.vue  (+4 è¡Œ, -12 è¡Œ) - é›†æˆ

æ€»è®¡ï¼š~1800 è¡Œæ–°ä»£ç 
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. å£°æ˜å¼ç­–ç•¥å®šä¹‰

```typescript
export const stagingToDailyStrategy: Strategy = {
  id: 'staging-to-daily',
  name: 'Staging to Daily Schedule',

  conditions: {
    source: {
      viewKey: 'misc::staging',
      taskStatus: 'staging',
    },
    target: {
      viewKey: /^daily::\d{4}-\d{2}-\d{2}$/, // æ­£åˆ™åŒ¹é…
    },
    priority: 100,
  },

  action: {
    name: 'schedule_task',
    description: 'å°†æš‚å­˜åŒºä»»åŠ¡å®‰æ’åˆ°æŒ‡å®šæ—¥æœŸ',

    async execute(ctx) {
      // æ‰“å°æ¨¡å¼ï¼šåªè®°å½•ï¼Œä¸æ‰§è¡Œ
      console.log(`ğŸ“… [PRINT MODE] Would schedule task...`)
      return { success: true, message: '...' }
    },
  },

  tags: ['scheduling', 'staging', 'daily'],
}
```

### 2. æ™ºèƒ½åŒ¹é…ç®—æ³•

**4 çº§ä¼˜å…ˆçº§**ï¼š

1. ç²¾ç¡®åŒ¹é…ï¼ˆå­—ç¬¦ä¸² viewKeyï¼‰
2. æ­£åˆ™åŒ¹é…ï¼ˆRegExp viewKeyï¼‰
3. ç±»å‹åŒ¹é…ï¼ˆviewTypeï¼‰
4. è‡ªå®šä¹‰æ£€æŸ¥ï¼ˆcustomCheckï¼‰

**æ’åºè§„åˆ™**ï¼šæŒ‰ `priority` é™åºï¼Œè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„ç­–ç•¥

### 3. å®Œæ•´çš„å¯è§‚æµ‹æ€§

- **æ§åˆ¶å°åˆ†ç»„æ—¥å¿—**ï¼šæ¯æ¬¡ç­–ç•¥æ‰§è¡Œéƒ½æ‰“å°è¯¦ç»†ä¿¡æ¯
- **æŒ‡ä»¤è¿½è¸ªé›†æˆ**ï¼šè‡ªåŠ¨è®°å½• IF â†’ EX â†’ RES â†’ WB
- **è°ƒè¯•å·¥å…·**ï¼š`strategyRegistry.debug()` æŸ¥çœ‹æ‰€æœ‰ç­–ç•¥

ç¤ºä¾‹è¾“å‡ºï¼š

```
ğŸ¯ Drag Strategy: Staging to Daily Schedule (staging-to-daily)
  ğŸ“‹ Strategy Details
  ğŸ” Matching Conditions
  ğŸ“¦ Context Data
  âš™ï¸ Strategy Conditions
  ğŸ¬ Action to Execute

ğŸ“… [PRINT MODE] Would schedule task:
  Task: "å›¢é˜Ÿä¼šè®®"
  From: misc::staging
  To: daily::2025-01-15 (2025-01-15)
  Drop Index: 2
  Command: task.create_with_schedule
  Payload: {...}
```

### 4. å¼€å‘è€…å‹å¥½

- **å…¨å±€è®¿é—®**ï¼š`window.strategyRegistry` å’Œ `window.strategyExecutor`
- **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript æ”¯æŒ
- **é›¶ä¾µå…¥**ï¼šä¸ä¿®æ”¹æ—§ä»£ç ï¼Œå®Œå…¨ç‹¬ç«‹
- **æ¸è¿›å¼**ï¼šå¯é€æ­¥æ·»åŠ æ–°ç­–ç•¥

---

## ğŸ”„ ä¸æ—§ç³»ç»Ÿå¯¹æ¯”

| ç»´åº¦         | æ—§ç³»ç»Ÿ          | æ–°ç³»ç»Ÿ          |
| ------------ | --------------- | --------------- |
| **å®šä¹‰æ–¹å¼** | å‡½æ•° + å­—ç¬¦ä¸²é”® | å£°æ˜å¼å…ƒæ•°æ®    |
| **åŒ¹é…ç®—æ³•** | ç®€å•é”®å€¼æŸ¥æ‰¾    | å¤šæ¡ä»¶ç»„åˆåŒ¹é…  |
| **ä¼˜å…ˆçº§**   | æ—               | æ”¯æŒæ•°å­—ä¼˜å…ˆçº§  |
| **æ­£åˆ™åŒ¹é…** | å¦              | æ”¯æŒ            |
| **ç±»å‹å®‰å…¨** | éƒ¨åˆ†            | å®Œå…¨            |
| **å¯è°ƒè¯•æ€§** | å›°éš¾            | è¯¦ç»†æ—¥å¿— + å·¥å…· |
| **å¯æµ‹è¯•æ€§** | éš¾ä»¥éš”ç¦»        | ç­–ç•¥ç‹¬ç«‹        |
| **æ‰©å±•æ€§**   | éœ€ä¿®æ”¹æ ¸å¿ƒ      | æ³¨å†Œå¼ï¼Œé›¶ä¾µå…¥  |

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ç»„ä»¶ä¸­æ‰§è¡Œç­–ç•¥

```vue
<script setup lang="ts">
import { useDragStrategy } from '@/composables/drag/useDragStrategy'

const dragStrategy = useDragStrategy()

const { displayTasks } = useInteractDrag({
  // ... å…¶ä»–é…ç½®
  onDrop: async (session) => {
    const result = await dragStrategy.executeDrop(session, props.viewKey)

    if (result.success) {
      showMessage(result.message)
    } else {
      showError(result.error)
    }
  },
})
</script>
```

### åœ¨æ§åˆ¶å°è°ƒè¯•

```javascript
// æŸ¥çœ‹æ‰€æœ‰ç­–ç•¥
strategyRegistry.debug()

// è¾“å‡ºï¼š
// ğŸ¯ Registered Drag Strategies:
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ID    â”‚ Name                â”‚ Priority â”‚ Enabled â”‚ Tags   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ ...   â”‚ ...                 â”‚ ...      â”‚ ...     â”‚ ...    â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// è·å–ç»Ÿè®¡ä¿¡æ¯
strategyRegistry.getStats()

// è¾“å‡ºï¼š
// {
//   totalStrategies: 4,
//   enabledStrategies: 4,
//   disabledStrategies: 0,
//   strategiesByTag: {
//     scheduling: 4,
//     staging: 3,
//     daily: 3,
//     ...
//   }
// }

// æŒ‰æ ‡ç­¾æŸ¥æ‰¾
strategyRegistry.findByTag('scheduling')

// ä¸´æ—¶ç¦ç”¨ç­–ç•¥
strategyRegistry.disable('staging-to-daily')

// é‡æ–°å¯ç”¨
strategyRegistry.enable('staging-to-daily')
```

---

## âš ï¸ å½“å‰é™åˆ¶

1. **æ‰“å°æ¨¡å¼** - ç­–ç•¥åªæ‰“å°æ‰§è¡Œè®¡åˆ’ï¼Œä¸æ‰§è¡Œå®é™…ä¸šåŠ¡ï¼ˆéœ€è¦åç»­åˆ‡æ¢ï¼‰
2. **æ— é¢„è§ˆ UI** - é¼ æ ‡ hover æ—¶ä¸æ˜¾ç¤ºç­–ç•¥æç¤ºï¼ˆé¢„ç•™æ¥å£ï¼‰
3. **æ— å›æ»š** - ç­–ç•¥æ‰§è¡Œå¤±è´¥åä¸è‡ªåŠ¨å›æ»šï¼ˆé¢„ç•™æ¥å£ï¼‰
4. **å•ç­–ç•¥åŒ¹é…** - æ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªç­–ç•¥ï¼ˆæœªæ¥å¯æ”¯æŒç­–ç•¥ç»„åˆï¼‰

---

## ğŸ”® æœªæ¥å¢å¼º

- [ ] **åˆ‡æ¢åˆ°å®é™…æ‰§è¡Œæ¨¡å¼** - è°ƒç”¨ commandBus æ‰§è¡ŒçœŸå®ä¸šåŠ¡
- [ ] **ç­–ç•¥é¢„è§ˆ UI** - hover æ—¶æ˜¾ç¤ºç­–ç•¥æç¤ºæ¡†
- [ ] **ç­–ç•¥ç»„åˆ** - æ”¯æŒå¤šä¸ªç­–ç•¥ç»„æˆ pipeline
- [ ] **å¼‚æ­¥æ¡ä»¶æ£€æŸ¥** - canExecute æ”¯æŒå¼‚æ­¥éªŒè¯
- [ ] **ç­–ç•¥å›æ»šæœºåˆ¶** - å¤±è´¥æ—¶è‡ªåŠ¨è°ƒç”¨ rollback
- [ ] **æ€§èƒ½ç›‘æ§** - è®°å½•ç­–ç•¥æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡
- [ ] **æ›´å¤šå†…ç½®ç­–ç•¥** - æ·»åŠ çŠ¶æ€åˆ‡æ¢ã€é¡¹ç›®ç®¡ç†ç­‰ç­–ç•¥

---

## âœ¨ æ¶æ„ä¼˜åŠ¿

1. **èŒè´£æ¸…æ™°**
   - Registry: ç®¡ç†ç­–ç•¥ç”Ÿå‘½å‘¨æœŸ
   - Matcher: çº¯åŒ¹é…ç®—æ³•
   - Executor: æ‰§è¡Œå’Œè¿½è¸ª
   - Strategy: ä¸šåŠ¡é€»è¾‘

2. **é«˜å†…èšä½è€¦åˆ**
   - ç­–ç•¥ä¹‹é—´å®Œå…¨ç‹¬ç«‹
   - åŒ¹é…ç®—æ³•å¯å•ç‹¬æµ‹è¯•
   - æ‰§è¡Œå¼•æ“å¯æ›¿æ¢

3. **å¯æ‰©å±•**
   - æ–°å¢ç­–ç•¥ï¼šåªéœ€æ³¨å†Œï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒ
   - æ–°å¢æ¡ä»¶ç±»å‹ï¼šæ‰©å±• StrategyCondition
   - æ–°å¢æ‰§è¡Œæ¨¡å¼ï¼šæ‰©å±• StrategyAction

4. **å¯ç»´æŠ¤**
   - æ¯ä¸ªç­–ç•¥ä¸€ä¸ªæ–‡ä»¶
   - å£°æ˜å¼é…ç½®æ˜“è¯»
   - å®Œæ•´çš„ç±»å‹æ£€æŸ¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç­–ç•¥ç³»ç»Ÿ README](./src/infra/drag/README.md)
- [ç±»å‹å®šä¹‰](./src/infra/drag/types.ts)
- [ç­–ç•¥ç¤ºä¾‹](./src/infra/drag/strategies/task-scheduling.ts)

---

## ğŸ‰ æ€»ç»“

**å…¨æ–°çš„æ‹–æ”¾ç­–ç•¥ç³»ç»Ÿå·²å®Œæ•´å®ç°**ï¼Œæä¾›äº†ï¼š

âœ… å£°æ˜å¼ç­–ç•¥å®šä¹‰  
âœ… æ™ºèƒ½æ¡ä»¶åŒ¹é…  
âœ… å®Œæ•´çš„å¯è§‚æµ‹æ€§  
âœ… ç±»å‹å®‰å…¨ä¿éšœ  
âœ… å¼€å‘è€…å‹å¥½å·¥å…·  
âœ… é›¶ä¾µå…¥é›†æˆ

**å½“å‰çŠ¶æ€**ï¼šæ‰“å°æ¨¡å¼ï¼Œæ‰€æœ‰ç­–ç•¥æ­£å¸¸åŒ¹é…å’Œæ‰§è¡Œï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—ã€‚  
**ä¸‹ä¸€æ­¥**ï¼šåˆ‡æ¢åˆ°å®é™…æ‰§è¡Œæ¨¡å¼ï¼Œè°ƒç”¨ commandBus æ‰§è¡ŒçœŸå®ä¸šåŠ¡é€»è¾‘ã€‚
