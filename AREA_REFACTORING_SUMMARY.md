# Area å­—æ®µé‡æ„æ€»ç»“æŠ¥å‘Š

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³ N+1 æŸ¥è¯¢é—®é¢˜ï¼šå°† TaskCard ä¸­çš„å®Œæ•´ area å¯¹è±¡æ”¹ä¸ºåªä¼ é€’ area_idï¼Œå‰ç«¯åœ¨åº”ç”¨å¯åŠ¨æ—¶ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ areasã€‚

## âœ… é‡æ„å®Œæˆæƒ…å†µ

### åç«¯ä¿®æ”¹ï¼ˆ13 ä¸ªæ–‡ä»¶ï¼‰

#### 1. å®ä½“å±‚ä¿®æ”¹

- âœ… `src-tauri/src/entities/task/response_dtos.rs`
  - å°† `area: Option<AreaSummary>` æ”¹ä¸º `area_id: Option<Uuid>`

#### 2. è£…é…å™¨å±‚ä¿®æ”¹

- âœ… `src-tauri/src/features/tasks/shared/assembler.rs`
  - `task_to_card_basic()` ç›´æ¥å¡«å…… `area_id`
  - ç§»é™¤ `task_to_card_full()` çš„ area å‚æ•°
  - åˆ é™¤æœªä½¿ç”¨çš„ `AreaSummary` import

#### 3. Tasks ç«¯ç‚¹ä¿®æ”¹ï¼ˆ6 ä¸ªæ–‡ä»¶ï¼‰

- âœ… `src-tauri/src/features/tasks/endpoints/create_task.rs`
  - ç§»é™¤ AreaRepository::get_summary è°ƒç”¨
  - åˆ é™¤ç›¸å…³ import
- âœ… `src-tauri/src/features/tasks/endpoints/get_task.rs`
  - ç§»é™¤ area æŸ¥è¯¢é€»è¾‘
- âœ… `src-tauri/src/features/tasks/endpoints/update_task.rs`
  - ç§»é™¤äº‹åŠ¡å†…çš„ area æŸ¥è¯¢
- âœ… `src-tauri/src/features/tasks/endpoints/complete_task.rs`
  - ç§»é™¤ area å¡«å……ä»£ç 
  - ä¿®å¤ unused mut è­¦å‘Š
- âœ… `src-tauri/src/features/tasks/endpoints/reopen_task.rs`
  - ç§»é™¤ area æŸ¥è¯¢é€»è¾‘
- âœ… `src-tauri/src/features/time_blocks/endpoints/create_from_task.rs`
  - ç§»é™¤è¿”å› TaskCard æ—¶çš„ area æŸ¥è¯¢

#### 4. Views ç«¯ç‚¹ä¿®æ”¹ï¼ˆ5 ä¸ªæ–‡ä»¶ï¼‰

- âœ… `src-tauri/src/features/views/shared/task_card_assembler.rs`
  - `assemble_full()` ç§»é™¤ area æŸ¥è¯¢
  - `assemble_with_status()` ç§»é™¤ area æŸ¥è¯¢
  - åˆ é™¤ AreaRepository import
- âœ… `src-tauri/src/features/views/endpoints/get_all.rs`
  - ç§»é™¤ `assemble_task_card()` ä¸­çš„ area æŸ¥è¯¢
  - åˆ é™¤ `get_area_summary()` å‡½æ•°
  - åˆ é™¤æœªä½¿ç”¨çš„ import
- âœ… `src-tauri/src/features/views/endpoints/get_all_incomplete.rs`
  - åŒä¸Š
- âœ… `src-tauri/src/features/views/endpoints/get_planned.rs`
  - åŒä¸Š
- âœ… `src-tauri/src/features/views/endpoints/get_staging_view.rs`
  - åŒä¸Š

### å‰ç«¯ä¿®æ”¹ï¼ˆ2 ä¸ªæ–‡ä»¶ï¼‰

#### 1. ç±»å‹å®šä¹‰ä¿®æ”¹

- âœ… `src/types/dtos.ts`
  - TaskCard interface: `area: {...}` â†’ `area_id: string | null`

#### 2. åº”ç”¨å¯åŠ¨é€»è¾‘ä¿®æ”¹

- âœ… `src/main.ts`
  - åœ¨ API é…ç½®åˆå§‹åŒ–åç«‹å³åŠ è½½æ‰€æœ‰ areas
  - ä½¿ç”¨ dynamic import é¿å…å¾ªç¯ä¾èµ–

### æ–‡æ¡£åˆ›å»º

- âœ… `AREA_REFACTORING_MIGRATION_GUIDE.md` - ç»„ä»¶è¿ç§»æŒ‡å—
- âœ… `AREA_REFACTORING_SUMMARY.md` - æœ¬æ€»ç»“æŠ¥å‘Š

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### åç«¯ä¼˜åŒ–

- **æ¶ˆé™¤ N+1 æŸ¥è¯¢**ï¼šæ¯ä¸ªä»»åŠ¡ä¸å†æŸ¥è¯¢ area è¡¨
- **å‡å°‘æ•°æ®åº“è´Ÿè½½**ï¼šå¤§å¹…å‡å°‘ SELECT æŸ¥è¯¢æ¬¡æ•°
  - ä¹‹å‰ï¼šæ¯ä¸ªä»»åŠ¡ 1 æ¬¡ area æŸ¥è¯¢
  - ç°åœ¨ï¼š0 æ¬¡ï¼ˆå®Œå…¨ä¸æŸ¥è¯¢ï¼‰
- **å‡å°‘å“åº”ä½“ç§¯**ï¼šæ¯ä¸ªä»»åŠ¡èŠ‚çœçº¦ 50 å­—èŠ‚
  - area å¯¹è±¡ï¼š`{"id": "...", "name": "...", "color": "..."}`
  - area_idï¼š`"..."`

### å‰ç«¯ä¼˜åŒ–

- **ä¸€æ¬¡æ€§åŠ è½½**ï¼šåº”ç”¨å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰ areasï¼ˆé€šå¸¸ < 50 ä¸ªï¼‰
- **æœ¬åœ°æŸ¥è¯¢**ï¼šé€šè¿‡ Map.get() æŸ¥è¯¢ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)
- **å“åº”å¼æ›´æ–°**ï¼šarea æ›´æ–°æ—¶æ‰€æœ‰ä½¿ç”¨å®ƒçš„ç»„ä»¶è‡ªåŠ¨å“åº”

## ğŸ” ç¼–è¯‘éªŒè¯

### åç«¯ï¼ˆRustï¼‰

```bash
$ cd src-tauri && cargo check
    Checking explore v0.1.0
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 3.31s
âœ… æ— é”™è¯¯ã€æ— è­¦å‘Š
```

### å‰ç«¯ï¼ˆTypeScriptï¼‰

- âš ï¸ éœ€è¦æ‰‹åŠ¨è¿è¡Œç±»å‹æ£€æŸ¥å’Œæµ‹è¯•
- âš ï¸ éœ€è¦ä¿®æ”¹æ‰€æœ‰ä½¿ç”¨ `task.area` çš„ç»„ä»¶

## ğŸ“‹ å¾…åŠäº‹é¡¹ï¼ˆå‰ç«¯ç»„ä»¶è¿ç§»ï¼‰

### éœ€è¦ä¿®æ”¹çš„ç»„ä»¶æ¨¡å¼

æ‰€æœ‰ä½¿ç”¨ `task.area` çš„åœ°æ–¹éœ€è¦æ”¹ä¸ºï¼š

```typescript
// âŒ æ—§ç‰ˆæœ¬
task.area?.name
task.area?.color

// âœ… æ–°ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
const areaStore = useAreaStore()
const area = computed(() => (task.area_id ? areaStore.getAreaById(task.area_id) : null))
// ä½¿ç”¨ area.value?.name, area.value?.color

// âœ… æˆ–è€…ï¼ˆç®€å•åœºæ™¯ï¼‰
areaStore.getAreaById(task.area_id)?.name
```

### å¯èƒ½éœ€è¦ä¿®æ”¹çš„ç»„ä»¶

æœç´¢å…³é”®è¯ï¼š`task.area`ã€`.area.name`ã€`.area.color`ã€`.area.id`

å…¸å‹ç»„ä»¶ç±»å‹ï¼š

1. ä»»åŠ¡å¡ç‰‡ç»„ä»¶ï¼ˆæ˜¾ç¤º area æ ‡ç­¾ï¼‰
2. ä»»åŠ¡åˆ—è¡¨ç»„ä»¶ï¼ˆæŒ‰ area åˆ†ç»„/ç­›é€‰ï¼‰
3. ä»»åŠ¡ç¼–è¾‘å™¨ï¼ˆæ˜¾ç¤º/é€‰æ‹© areaï¼‰
4. ç»Ÿè®¡é¢æ¿ï¼ˆæŒ‰ area ç»Ÿè®¡ï¼‰

## ğŸ§ª æµ‹è¯•éªŒè¯æ¸…å•

### åç«¯æµ‹è¯•

- [x] ç¼–è¯‘é€šè¿‡ï¼ˆæ— é”™è¯¯ã€æ— è­¦å‘Šï¼‰
- [ ] åˆ›å»ºä»»åŠ¡ - area_id æ­£ç¡®è¿”å›
- [ ] è·å–ä»»åŠ¡ - area_id æ­£ç¡®è¿”å›
- [ ] æ›´æ–°ä»»åŠ¡ - area_id æ­£ç¡®è¿”å›
- [ ] è§†å›¾ç«¯ç‚¹ - æ‰€æœ‰ä»»åŠ¡çš„ area_id æ­£ç¡®è¿”å›

### å‰ç«¯æµ‹è¯•ï¼ˆéœ€è¦æ‰‹åŠ¨è¿›è¡Œï¼‰

- [ ] åº”ç”¨å¯åŠ¨æ—¶æˆåŠŸåŠ è½½æ‰€æœ‰ areas
- [ ] ä»»åŠ¡å¡ç‰‡ä¸Š area é¢œè‰²æ­£ç¡®æ˜¾ç¤º
- [ ] ä»»åŠ¡å¡ç‰‡ä¸Š area åç§°æ­£ç¡®æ˜¾ç¤º
- [ ] æ›´æ–°ä»»åŠ¡ area åç•Œé¢ç«‹å³æ›´æ–°
- [ ] æŒ‰ area ç­›é€‰ä»»åŠ¡åŠŸèƒ½æ­£å¸¸
- [ ] Area ç®¡ç†ï¼ˆåˆ›å»º/æ›´æ–°/åˆ é™¤ï¼‰åä»»åŠ¡æ˜¾ç¤ºæ­£ç¡®

### æ€§èƒ½æµ‹è¯•

- [ ] åº”ç”¨å¯åŠ¨æ—¶é—´å¯¹æ¯”
- [ ] ä»»åŠ¡åˆ—è¡¨åŠ è½½æ—¶é—´å¯¹æ¯”
- [ ] ç½‘ç»œè¯·æ±‚æ•°é‡å¯¹æ¯”
- [ ] æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—åˆ†æ

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **Area Store ä¾èµ–**ï¼šæ‰€æœ‰ä½¿ç”¨ area çš„ç»„ä»¶ç°åœ¨éƒ½ä¾èµ– area store
2. **å“åº”å¼æ›´æ–°**ï¼šarea store æ˜¯å“åº”å¼çš„ï¼Œæ›´æ–°åç»„ä»¶ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“
3. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨æ¨¡æ¿ä¸­å¤šæ¬¡è°ƒç”¨ getAreaByIdï¼Œä½¿ç”¨ computed ç¼“å­˜
4. **ç©ºå€¼å¤„ç†**ï¼šä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦ `?.` å¤„ç† area ä¸å­˜åœ¨çš„æƒ…å†µ

## ğŸ“– ç›¸å…³æ–‡æ¡£

- `AREA_REFACTORING_MIGRATION_GUIDE.md` - è¯¦ç»†çš„ç»„ä»¶è¿ç§»æŒ‡å—
- `references/DATA_SCHEMA_COUPLING.md` - æ•°æ®ç»“æ„è€¦åˆè¯´æ˜ä¹¦

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸä¹‹å¤„

1. **å½»åº•çš„ä»£ç å®¡æŸ¥**ï¼šä½¿ç”¨ grep æœç´¢æ‰€æœ‰ç›¸å…³ä»£ç ï¼Œç¡®ä¿ä¸é—æ¼
2. **æ¸…æ™°çš„æ³¨é‡Šæ ‡è®°**ï¼šä½¿ç”¨ `âœ…` æ ‡è®°æ‰€æœ‰ä¿®æ”¹è¿‡çš„åœ°æ–¹ï¼Œä¾¿äºè¿½è¸ª
3. **æ¸è¿›å¼ä¿®æ”¹**ï¼šå…ˆä¿®æ”¹æ ¸å¿ƒ DTOï¼Œå†ä¿®æ”¹è£…é…å™¨ï¼Œæœ€åä¿®æ”¹ç«¯ç‚¹
4. **ç¼–è¯‘é©±åŠ¨**ï¼šé€šè¿‡ç¼–è¯‘é”™è¯¯å®šä½æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„åœ°æ–¹
5. **æ–‡æ¡£ä¼˜å…ˆ**ï¼šå…ˆåˆ›å»ºè¿ç§»æŒ‡å—ï¼Œå¸®åŠ©åç»­ç»„ä»¶è¿ç§»

### æ”¹è¿›å»ºè®®

1. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šåº”è¯¥æœ‰é›†æˆæµ‹è¯•è¦†ç›–æ‰€æœ‰ç«¯ç‚¹
2. **å‰ç«¯ç±»å‹æ£€æŸ¥**ï¼šåº”è¯¥åœ¨ CI ä¸­è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
3. **æ•°æ®åº“æŸ¥è¯¢ç›‘æ§**ï¼šåº”è¯¥æœ‰å·¥å…·ç›‘æ§ N+1 æŸ¥è¯¢é—®é¢˜

---

**é‡æ„çŠ¶æ€**ï¼šâœ… åç«¯å®Œæˆ | âš ï¸ å‰ç«¯ç»„ä»¶éœ€è¦æ‰‹åŠ¨è¿ç§»

**ç¼–è¯‘çŠ¶æ€**ï¼šâœ… æ— é”™è¯¯ã€æ— è­¦å‘Š

**ä¸‹ä¸€æ­¥**ï¼šæŒ‰ç…§ `AREA_REFACTORING_MIGRATION_GUIDE.md` è¿ç§»å‰ç«¯ç»„ä»¶
